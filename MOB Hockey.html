<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>MOB Party: Air Hockey (Dealer Match)</title>
<style>
  :root{
    --hud:#0e0f12cc; --fg:#fff; --good:#30d158; --bad:#ff453a;
    --board:#1a1f27; --rink:#0a0c10;
  }
  html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui,-apple-system,"Yu Gothic",sans-serif}
  #wrap{position:fixed;inset:0;display:flex;align-items:stretch;justify-content:center;background:#000;}
  canvas{display:block;touch-action:none;outline:none;background:var(--rink)}
  .hud{position:fixed;z-index:10;top:env(safe-area-inset-top);left:0;right:0;display:flex;justify-content:space-between;gap:8px;align-items:center;padding:8px 12px;background:var(--hud);backdrop-filter: blur(6px);}
  .hud .left{display:flex;gap:12px;align-items:center}
  .pill{padding:6px 10px;background:#1b1f27;border-radius:999px;font-weight:600;font-variant-numeric:tabular-nums}
  .score{display:flex;gap:8px;align-items:center}
  .score b{font-size:18px}
  .mid{font-size:12px;color:#cbd3e1}
  .leader{position:fixed;z-index:10;right:8px;top:calc(56px + env(safe-area-inset-top)); width:min(38vw,220px);background:var(--hud); backdrop-filter: blur(6px); border-radius:12px; padding:8px}
  .leader h4{margin:2px 6px 6px; font-size:12px; color:#ddd; font-weight:600}
  .leader .row{display:flex;justify-content:space-between;align-items:center;padding:4px 6px;margin:2px 0;border-radius:8px}
  .leader .me{background:#22304a}
  .leader .deal{background:#2b2438}
  .goalFlash{position:fixed;inset:0;pointer-events:none;opacity:0;transition:opacity .25s}
  .goalFlash.good{background:radial-gradient(ellipse at center, rgba(48,209,88,.25), transparent 60%)}
  .goalFlash.bad{background:radial-gradient(ellipse at center, rgba(255,69,58,.25), transparent 60%)}
  .overlay{position:fixed;inset:0;display:grid;place-items:center;background:transparent;pointer-events:none}
  .count{font-size:14vw;font-weight:900;text-shadow:0 6px 24px rgba(0,0,0,.6)}
  .sub{position:fixed;bottom:calc(14px + env(safe-area-inset-bottom));left:0;right:0;text-align:center;font-size:14px;color:#cbd3e1}
  .btnBar{position:fixed;inset:auto 0 0 0;display:flex;justify-content:center;gap:12px;padding:12px;background:linear-gradient(to top, rgba(0,0,0,.55), transparent 60%)}
  .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;background:#1b1f27;color:#fff;font-weight:700}
  .watermark{position:fixed;left:10px;bottom:calc(8px + env(safe-area-inset-bottom));opacity:.6;font-size:12px}
  *{user-select:none;-webkit-user-select:none}
</style>
</head>
<body>
<div id="wrap"><canvas id="cv"></canvas></div>

<div class="hud">
  <div class="left">
    <div class="pill">TIME <b id="time">30.0</b>s</div>
    <div class="score">
      <div class="pill">YOU <b id="ps">0</b></div>
      <div class="pill">DEALER <b id="ds">0</b></div>
    </div>
  </div>
  <div class="mid">中央侵入禁止（スマッシャー） / 強打＝長押しでパワーUP</div>
  <div style="width:40px"></div>
</div>

<div class="leader" id="leader">
  <h4>リアルタイム順位</h4>
  <div id="board"></div>
</div>

<div id="flash" class="goalFlash"></div>

<div class="overlay" id="overlay">
  <div class="count" id="countTxt">3</div>
  <div class="sub">3・2・1・GO! の間も背景は表示されます</div>
</div>

<div class="btnBar" id="endBar" style="display:none">
  <button class="btn" id="restartBtn">もう一度</button>
</div>

<div class="watermark">MOB Party – Air Hockey</div>

<script>
(() => {
  // ===== Canvas =====
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d', { alpha:true });
  let W=0,H=0, DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  function fit(){ const w=innerWidth, h=innerHeight; W=w*DPR; H=h*DPR; cv.width=W; cv.height=H; cv.style.width=w+'px'; cv.style.height=h+'px'; refreshRink(); }
  addEventListener('resize', fit, {passive:true}); fit();

  // ===== Rink =====
  const pad = 16 * DPR, hudTop = 64*DPR, footer = 72*DPR;
  const rink = { x: pad, y: hudTop, w: 0, h: 0 };
  function refreshRink(){ rink.w = W - pad*2; rink.h = H - hudTop - footer; rink.x = pad; rink.y = hudTop; }

  // ===== Assets =====
  const images = {};
  [['black','black.png'],['blue','blue.png'],['green','green.png'],['mura','mura.png'],
   ['orange','orange.png'],['pink','pink.png'],['red','red.png'],['yellow','yellow.png'],
   ['smash','smash.png'],['bg','hokehai.png']].forEach(([k,src])=>{
    const im = new Image(); im.src = src; im.onload=()=>images[k]=im; im.onerror=()=>images[k]=null;
  });

  // ===== Names / Scores =====
  const playerName='YOU (RED)', dealerName='DEALER';
  const others=['BLUE','GREEN','PURPLE','ORANGE','PINK','BLACK','YELLOW'];
  const all=[playerName,dealerName,...others];
  const colors=['black','blue','green','mura','orange','pink','red','yellow'];
  const cname={black:'BLACK',blue:'BLUE',green:'GREEN',mura:'PURPLE',orange:'ORANGE',pink:'PINK',red:'RED',yellow:'YELLOW'};
  const scores={}; all.forEach(n=>scores[n]=0);

  // ===== HUD refs =====
  const timeEl=document.getElementById('time'), psEl=document.getElementById('ps'), dsEl=document.getElementById('ds');
  const boardEl=document.getElementById('board'), flashEl=document.getElementById('flash');
  const overlayEl=document.getElementById('overlay'), countTxt=document.getElementById('countTxt');
  const endBar=document.getElementById('endBar'); document.getElementById('restartBtn').addEventListener('click', boot);

  // ===== Utils =====
  const rand=(a,b)=>a+Math.random()*(b-a), clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const dist2=(ax,ay,bx,by)=>{const dx=ax-bx,dy=ay-by;return dx*dx+dy*dy;};

  // ===== Entities =====
  const P=[], MALLETS=[];
  function makePuck(kind,x,y){ const r=Math.max(18*DPR,Math.min(rink.w,rink.h)*0.018); return{type:'puck',kind,x,y,r,vx:rand(-140,140)*DPR,vy:rand(-120,120)*DPR}; }
  function makeMallet(owner,side){ const R=Math.max(28*DPR,Math.min(rink.w,rink.h)*0.04); const y=side==='you'?(rink.y+rink.h*0.75):(rink.y+rink.h*0.25); const x=rink.x+rink.w/2; return{type:'mallet',owner,side,x,y,r:R,vx:0,vy:0,charge:0}; }

  function resetField(){
    refreshRink(); P.length=0; MALLETS.length=0;
    const k=[...colors]; for(let i=k.length-1;i>0;i--){const j=(Math.random()*(i+1))|0; [k[i],k[j]]=[k[j],k[i]];}
    const top4=k.slice(0,4), bottom4=k.slice(4);
    const spawn=(list,side)=>{for(const c of list){ const x=rand(rink.x+rink.w*0.15,rink.x+rink.w*0.85); const y=side==='top'?rand(rink.y+rink.h*0.08,rink.y+rink.h*0.42):rand(rink.y+rink.h*0.58,rink.y+rink.h*0.92); P.push(makePuck(c,x,y)); }};
    spawn(top4,'top'); spawn(bottom4,'bottom');
    MALLETS.push(makeMallet(playerName,'you')); MALLETS.push(makeMallet(dealerName,'bot'));
  }

  // ===== Scoring =====
  function addScore(who,delta){ scores[who]=(scores[who]||0)+delta; }
  function onGoal(side,puck){
    const scorer= side==='top'? dealerName:playerName;
    const conceder= side==='top'? playerName:dealerName;
    addScore(scorer, (scorer===playerName && puck.kind==='red')?10:2);
    addScore(conceder, (conceder===playerName && puck.kind==='red')?-5:-1);
    flashEl.className='goalFlash ' + (scorer===playerName?'good':'bad'); flashEl.style.opacity='1'; setTimeout(()=>flashEl.style.opacity='0',180);
    const i=P.indexOf(puck); if(i>=0) P.splice(i,1);
    setTimeout(()=>{ const toBottom=(conceder===playerName); const x=rand(rink.x+rink.w*0.2,rink.x+rink.w*0.8); const y=toBottom?rand(rink.y+rink.h*0.65,rink.y+rink.h*0.9):rand(rink.y+rink.h*0.1,rink.y+rink.h*0.35); P.push(makePuck(puck.kind,x,y)); },350);
  }

  // ===== Background CPUs =====
  const bg=others.slice();
  function tickBG(dt){
    const chance=dt*0.8;
    if(Math.random()<chance){
      const s=bg[(Math.random()*bg.length)|0]; let c=s; while(c===s) c=bg[(Math.random()*bg.length)|0];
      const kind=colors[(Math.random()*colors.length)|0];
      addScore(s, cname[kind]===s?10:2);
      addScore(c, cname[kind]===c?-5:-1);
    }
  }

  // ===== Controls =====
  const pointer={down:false,x:0,y:0};
  cv.addEventListener('pointerdown',e=>{pointer.down=true; pointer.x=e.clientX*DPR; pointer.y=e.clientY*DPR;});
  cv.addEventListener('pointermove',e=>{pointer.x=e.clientX*DPR; pointer.y=e.clientY*DPR;});
  addEventListener('pointerup',()=>{pointer.down=false;});

  // ===== AI / Player =====
  function dealerAI(dt,m){
    let best=null,bd=1e9;
    for(const p of P){ const prefer=p.y<rink.y+rink.h*0.5; const d=dist2(m.x,m.y,p.x,p.y)*(prefer?1:1.4); if(d<bd){bd=d; best=p;} }
    const sp=Math.min(rink.w,rink.h)*2.2;
    if(best){
      const tx=clamp(best.x,rink.x+m.r,rink.x+rink.w-m.r);
      const ty=clamp(best.y,rink.y+m.r,rink.y+rink.h*0.48-m.r);
      const dx=tx-m.x, dy=ty-m.y, d=Math.hypot(dx,dy)||1, step=sp*DPR*dt;
      if(d>step){ m.x+=dx/d*step; m.y+=dy/d*step; } else { m.x=tx; m.y=ty; }
      m.charge=Math.min(1,m.charge+dt*0.8);
    }else{ const tx=rink.x+rink.w/2, ty=rink.y+rink.h*0.25; m.x+=(tx-m.x)*dt*1.5; m.y+=(ty-m.y)*dt*1.5; m.charge=Math.max(0,m.charge-dt*0.6); }
  }
  function playerCtrl(dt,m){
    const tx=clamp(pointer.x,rink.x+m.r,rink.x+rink.w-m.r);
    const top=rink.y+rink.h*0.52; const ty=clamp(pointer.y, top+m.r, rink.y+rink.h-m.r);
    const sp=Math.min(rink.w,rink.h)*3.0, dx=tx-m.x, dy=ty-m.y, d=Math.hypot(dx,dy)||1, step=sp*DPR*dt;
    if(d>step){ m.vx=dx/d*step; m.vy=dy/d*step; m.x+=m.vx; m.y+=m.vy; } else { m.vx=dx; m.vy=dy; m.x=tx; m.y=ty; }
    m.charge=Math.max(0,Math.min(1,m.charge+(pointer.down?dt*0.9:-dt*0.8)));
  }

  // ===== Physics =====
  function physics(dt){
    for(const p of P){
      p.x+=p.vx*dt; p.y+=p.vy*dt; p.vx*=(1-0.8*dt); p.vy*=(1-0.8*dt);
      const L=rink.x+p.r, R=rink.x+rink.w-p.r, T=rink.y+p.r, B=rink.y+rink.h-p.r;
      if(p.x<L){p.x=L;p.vx=-p.vx*0.9;} if(p.x>R){p.x=R;p.vx=-p.vx*0.9;}
      const goalW=Math.min(240*DPR,rink.w*0.22), gxL=rink.x+rink.w/2-goalW/2, gxR=gxL+goalW;
      if(p.y<rink.y+p.r){ if(p.x>=gxL && p.x<=gxR){ onGoal('top',p); continue; } p.y=T; p.vy=-p.vy*0.9; }
      if(p.y>rink.y+rink.h-p.r){ if(p.x>=gxL && p.x<=gxR){ onGoal('bottom',p); continue; } p.y=B; p.vy=-p.vy*0.9; }
    }
    for(const m of MALLETS){
      if(m.side==='you') playerCtrl(dt,m); else dealerAI(dt,m);
      if(m.side==='you'){ m.x=clamp(m.x,rink.x+m.r,rink.x+rink.w-m.r); m.y=clamp(m.y,rink.y+rink.h*0.52+m.r,rink.y+rink.h-m.r); }
      else { m.x=clamp(m.x,rink.x+m.r,rink.x+rink.w-m.r); m.y=clamp(m.y,rink.y+m.r,rink.y+rink.h*0.48-m.r); }
      for(const p of P){
        const dx=p.x-m.x, dy=p.y-m.y, rr=p.r+m.r, d2=dx*dx+dy*dy;
        if(d2<rr*rr){ const d=Math.sqrt(d2)||1, nx=dx/d, ny=dy/d, overlap=rr-d; p.x+=nx*overlap*0.7; p.y+=ny*overlap*0.7; let imp=Math.max(220*DPR,280*DPR); imp+=(m.side==='you'?520:420)*m.charge*DPR; p.vx+=nx*imp; p.vy+=ny*imp; m.charge=0; }
      }
    }
  }

  // ===== Draw =====
  function drawBG(){
    ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--board');
    ctx.fillRect(rink.x-8*DPR,rink.y-8*DPR,rink.w+16*DPR,rink.h+16*DPR);
    ctx.imageSmoothingEnabled=false;
    const bg=images['bg'];
    if(bg){
      const iw=bg.naturalWidth||bg.width, ih=bg.naturalHeight||bg.height, s=Math.min(rink.w/iw,rink.h/ih);
      const dw=Math.floor(iw*s), dh=Math.floor(ih*s), dx=Math.floor(rink.x+(rink.w-dw)/2), dy=Math.floor(rink.y+(rink.h-dh)/2);
      ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--rink'); ctx.fillRect(rink.x,rink.y,rink.w,rink.h);
      ctx.drawImage(bg,dx,dy,dw,dh);
    } else { ctx.fillStyle='#0b1218'; ctx.fillRect(rink.x,rink.y,rink.w,rink.h); }
  }
  function drawEntities(){
    for(const p of P){
      const im=images[p.kind];
      if(im){ const s=p.r*2; ctx.drawImage(im,Math.floor(p.x-p.r),Math.floor(p.y-p.r),s,s); }
      else { const cm={black:'#222',blue:'#2aa1ff',green:'#44d16b',mura:'#a26bff',orange:'#ff9f2a',pink:'#ff6fa6',red:'#ff4b4b',yellow:'#ffd82a'}; ctx.fillStyle=cm[p.kind]||'#888'; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='rgba(255,255,255,.15)'; ctx.stroke(); }
    }
    for(const m of MALLETS){
      const im=images['smash'];
      if(im){ const s=m.r*2; ctx.drawImage(im,Math.floor(m.x-m.r),Math.floor(m.y-m.r),s,s); }
      else { ctx.fillStyle=(m.side==='you')?'#e63946':'#6c5ce7'; ctx.beginPath(); ctx.arc(m.x,m.y,m.r,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='rgba(255,255,255,.2)'; ctx.lineWidth=3*DPR; ctx.stroke(); }
      if(m.charge>0){ ctx.beginPath(); ctx.strokeStyle=(m.side==='you')?'#30d158':'#a78bfa'; ctx.lineWidth=5*DPR; ctx.arc(m.x,m.y,m.r+8*DPR, -Math.PI/2, -Math.PI/2+Math.PI*2*m.charge); ctx.stroke(); }
    }
  }
  function draw(){ ctx.clearRect(0,0,W,H); drawBG(); drawEntities(); }

  // ===== Leaderboard =====
  function renderBoard(){
    const rows=Object.entries(scores).map(([name,sc])=>({name,sc})).sort((a,b)=>b.sc-a.sc);
    boardEl.innerHTML=rows.map((r,i)=>{ const cls=r.name===playerName?'row me':(r.name===dealerName?'row deal':'row'); const label=r.name.replace('(RED)','').trim(); return `<div class="${cls}"><span>${i+1}. ${label}</span><b>${r.sc}</b></div>`; }).join('');
    psEl.textContent=scores[playerName]|0; dsEl.textContent=scores[dealerName]|0;
  }

  // ===== Game state =====
  let phase='idle', tPlayStart=0, lastRAF=performance.now();
  function gameLoop(now){
    const dt=Math.min(0.033,(now-lastRAF)/1000); lastRAF=now;
    refreshRink();
    if(phase==='play'){
      const remain=Math.max(0,30000-(now-tPlayStart));
      timeEl.textContent=(Math.ceil(remain/100)/10).toFixed(1);
      physics(dt); tickBG(dt);
      if(remain<=0){ phase='end'; endBar.style.display='flex'; }
    }
    draw(); renderBoard(); requestAnimationFrame(gameLoop);
  }
  requestAnimationFrame(gameLoop);

  // ===== Countdown that never stalls =====
  function startCountdownThenPlay(){
    overlayEl.style.display='grid';
    countTxt.textContent='3';
    setTimeout(()=>{ countTxt.textContent='2';
      setTimeout(()=>{ countTxt.textContent='1';
        setTimeout(()=>{ countTxt.textContent='GO!';
          setTimeout(()=>{ overlayEl.style.display='none'; phase='play'; tPlayStart=performance.now(); }, 650);
        }, 1000);
      }, 1000);
    }, 1000);
  }

  // ===== Boot / Restart =====
  function boot(){
    scores[playerName]=0; scores[dealerName]=0; others.forEach(n=>scores[n]=0);
    timeEl.textContent='30.0'; endBar.style.display='none';
    resetField(); phase='countdown'; startCountdownThenPlay();
  }

  // 初期起動
  boot();
})();
</script>
</body>
</html>
