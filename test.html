<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no">
<title>Hockey Race</title>
<style>
  body { margin:0; background:#000; overflow:hidden; touch-action:none; }
  #gameCanvas { display:block; margin:0 auto; background:#111; }
  #overlay {
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,0.7); color:#fff; font-size:2rem; flex-direction:column; z-index:10;
  }
  button { margin:8px; padding:12px 24px; font-size:1.2rem; }
</style>
</head>
<body>
<div id="overlay">
  <div>ゲーム開始しますか？</div>
  <div>
    <button onclick="startGame()">はい</button>
    <button onclick="location.reload()">いいえ</button>
  </div>
</div>
<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
resize();
window.addEventListener("resize", resize);
function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}

let images = {};
let imageFiles = {
  red:"red.png", blue:"blue.png", yellow:"yellow.png", black:"black.png",
  pink:"pink.png", orange:"orange.png", green:"green.png", mura:"mura.png",
  contena:"contena.png", gomi:"gomi.png", hoke:"hoke.png"
};
for(let key in imageFiles){
  images[key] = new Image();
  images[key].src = imageFiles[key];
}

class Ball{
  constructor(color,x){
    this.color=color;
    this.x=x; this.y=canvas.height-60;
    this.w=40; this.h=40;
    this.vx=0; this.vy=-1;
    this.speed=0; this.finished=false; this.rank=null; this.points=0;
  }
  update(){
    if(this.finished) return;
    this.speed += 0.002;
    this.vy = -this.speed;
    this.x += this.vx;
    this.y += this.vy;
    if(this.x<0) { this.x=0; this.vx*=-0.5; }
    if(this.x+this.w>canvas.width) { this.x=canvas.width-this.w; this.vx*=-0.5; }
    if(this.y<0){ this.finished=true; this.y=0; finishers.push(this); }
  }
  draw(){
    ctx.drawImage(images[this.color],this.x,this.y,this.w,this.h);
  }
}

class Obstacle{
  constructor(type,x,y){
    this.type=type;
    this.x=x; this.y=y;
    this.w=(type=="contena")?80:60;
    this.h=(type=="contena")?80:80;
    this.vx=(type=="gomi")?1.5:0;
  }
  update(){
    if(this.type=="gomi"){
      this.x+=this.vx;
      if(this.x<0||this.x+this.w>canvas.width) this.vx*=-1;
    }
  }
  draw(){
    ctx.drawImage(images[this.type],this.x,this.y,this.w,this.h);
  }
}

let balls=[], obstacles=[], finishers=[], race=1, totalPoints={};
let keys={}, touch={left:false,right:false,up:false};
document.addEventListener("keydown",e=>keys[e.key]=true);
document.addEventListener("keyup",e=>keys[e.key]=false);
canvas.addEventListener("touchstart",e=>{
  let x=e.touches[0].clientX;
  let y=e.touches[0].clientY;
  if(y>canvas.height*0.7){
    if(x<canvas.width/3) touch.left=true;
    else if(x>canvas.width*2/3) touch.right=true;
    else touch.up=true;
  }
});
canvas.addEventListener("touchend",()=>{ touch.left=false; touch.right=false; touch.up=false; });

function initRace(){
  balls=[]; obstacles=[]; finishers=[];
  let colors=["red","blue","yellow","black","pink","orange","green","mura"];
  for(let i=0;i<colors.length;i++){
    balls.push(new Ball(colors[i],i*canvas.width/8));
  }
  // 障害物配置
  for(let i=0;i<6;i++){
    let type=(i%2==0)?"contena":"gomi";
    let x=Math.random()*(canvas.width-100);
    let y=Math.random()*canvas.height*0.8;
    obstacles.push(new Obstacle(type,x,y));
  }
}

let started=false, countdown=3, gameOver=false, fastMode=false;

function startGame(){
  document.getElementById("overlay").style.display="none";
  initRace();
  let cInt=setInterval(()=>{
    countdown--;
    if(countdown==0){ clearInterval(cInt); started=true; }
  },1000);
}

function update(){
  if(!started||gameOver) return;
  for(let o of obstacles) o.update();
  for(let b of balls){
    if(b.color=="red"){
      if(keys["ArrowLeft"]||touch.left) b.vx=-2;
      else if(keys["ArrowRight"]||touch.right) b.vx=2;
      else b.vx*=0.9;
      if((keys["ArrowUp"]||touch.up)&&b.vy>-5) b.vy-=0.5;
    } else {
      b.vx+=(Math.random()-0.5)*0.2;
    }
    b.update();
    for(let o of obstacles){
      if(b.x<b.x+40 && b.x+40>o.x && b.y<b.y+40 && b.y+40>o.y){
        b.vx*=-0.5; b.vy*=-0.5; 
      }
    }
  }
  // 衝突（ボール同士）
  for(let i=0;i<balls.length;i++){
    for(let j=i+1;j<balls.length;j++){
      let a=balls[i], b=balls[j];
      let dx=a.x-b.x, dy=a.y-b.y;
      if(Math.abs(dx)<40 && Math.abs(dy)<40){
        a.vx*=-0.5; b.vx*=-0.5;
      }
    }
  }
  if(finishers.length==balls.length){
    showResult();
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(images.hoke,0,0,canvas.width,canvas.height);
  for(let o of obstacles) o.draw();
  for(let b of balls) b.draw();
  if(!started){
    ctx.fillStyle="#fff"; ctx.font="40px sans-serif";
    ctx.fillText(countdown>0?countdown:"GO!",canvas.width/2-40,canvas.height/2);
  }
}

function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();

function showResult(){
  gameOver=true;
  ctx.fillStyle="yellow"; ctx.font="60px sans-serif";
  ctx.fillText("FINISH!",canvas.width/2-120,canvas.height/2);
  setTimeout(()=>{
    finishers.forEach((b,i)=>{
      let pts=[10,7,5,3,1][i]||0;
      totalPoints[b.color]=(totalPoints[b.color]||0)+pts;
    });
    if(race<3){ race++; started=false; gameOver=false; countdown=3; startGame();}
    else{
      ctx.fillStyle="#fff"; ctx.font="30px sans-serif";
      let y=100;
      for(let c in totalPoints){
        ctx.fillText(c+" : "+totalPoints[c],50,y); y+=40;
      }
    }
  },2000);
}
</script>
</body>
</html>
