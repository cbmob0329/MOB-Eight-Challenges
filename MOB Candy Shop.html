<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>MOB Candy Shop</title>
<style>
  :root{ --hud:#0e0f12cc; --fg:#fff; }
  html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui,-apple-system,"Yu Gothic",sans-serif}
  #wrap{position:fixed;inset:0;display:flex;align-items:stretch;justify-content:center;background:#000;}
  canvas{display:block;touch-action:none;outline:none}
  .hud{position:fixed;top:env(safe-area-inset-top);left:0;right:0;display:flex;justify-content:space-between;padding:6px 12px;background:var(--hud);z-index:10}
  .hud .pill{padding:4px 10px;border-radius:999px;background:#1b1f27}
  .footer{position:fixed;bottom:env(safe-area-inset-bottom);left:0;right:0;display:flex;justify-content:center;padding:6px;background:linear-gradient(180deg,transparent,rgba(0,0,0,.6));z-index:10}
  .equipBox{padding:6px 10px;border-radius:12px;background:#111a;backdrop-filter:blur(4px);display:flex;align-items:center;gap:6px}
  .equipIcon{width:40px;height:40px;border-radius:8px;border:2px solid #fff3;background-size:contain;background-repeat:no-repeat;background-position:center}
  .muted{opacity:.4}
  .centerText{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;font-weight:900}
  .centerText span{font-size:13vmin;opacity:0;transition:.2s}
</style>
</head>
<body>
<div id="wrap"><canvas id="cv"></canvas></div>

<div class="hud">
  <div class="pill" id="time">TIME 60.0</div>
  <div class="pill" id="score">SCORE 0</div>
</div>
<div class="footer">
  <div class="equipBox">選択中：<span id="equipIcon" class="equipIcon muted"></span></div>
</div>
<div class="centerText"><span id="center"></span></div>

<script>
(()=>{
const cv=document.getElementById("cv"),ctx=cv.getContext("2d");
let W=0,H=0,dpr=1;
function resize(){
  dpr=Math.min(2,window.devicePixelRatio||1);
  W=window.innerWidth;H=window.innerHeight;
  cv.width=W*dpr;cv.height=H*dpr;
  cv.style.width=W+"px";cv.style.height=H+"px";
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener("resize",resize);resize();

const IMGS={
  bg:"shop.png",
  items:{choco:"1cho.png",gumi:"1gumi.png",gum:"1gum.png",ame:"1ame.png"},
};
const images={items:{}};
function loadImage(src){return new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.onerror=()=>r(null);i.src=src;});}
async function loadAll(){
  images.bg=await loadImage(IMGS.bg);
  for(const k in IMGS.items){images.items[k]=await loadImage(IMGS.items[k]);}
}

// ===== game state =====
const LANES=['A','B','C','D'];
let plates={A:{item:null},B:{item:null},C:{item:null},D:{item:null}};
let equip=null;const equipIcon=document.getElementById("equipIcon");
let started=false,timeLeft=60,score=0,last=0;
const HUDt=document.getElementById("time"),HUDs=document.getElementById("score"),center=document.getElementById("center");

function updateEquipUI(){
  if(!equip){equipIcon.classList.add("muted");equipIcon.style.backgroundImage="";}
  else{equipIcon.classList.remove("muted");equipIcon.style.backgroundImage=`url(${IMGS.items[equip]})`;}
}

// ===== input =====
cv.addEventListener("click",e=>{
  if(!started)return;
  const x=e.clientX,y=e.clientY;
  const lane=hitPlate(x,y);
  if(lane&&equip){plates[lane].item=equip;}
  // アイコン選択はA〜Dの下にある固定アイコンをタップ
  const sel=hitFixedItems(x,y);
  if(sel){equip=sel;updateEquipUI();}
});

function hitPlate(x,y){
  const r=Math.min(W,H)*0.07;
  const X=[0.17,0.38,0.62,0.83].map(v=>v*W),Y=H*0.73;
  for(let i=0;i<4;i++){
    const dx=x-X[i],dy=y-Y;
    if(dx*dx+dy*dy<=r*r)return LANES[i];
  }
  return null;
}
function hitFixedItems(x,y){
  const items=['choco','gumi','gum','ame'];
  const X=[0.17,0.38,0.62,0.83].map(v=>v*W), Y=H*0.85, size=W*0.12;
  for(let i=0;i<4;i++){
    if(x>=X[i]-size/2&&x<=X[i]+size/2&&y>=Y-size/2&&y<=Y+size/2)return items[i];
  }
  return null;
}

// ===== loop =====
function loop(t){
  const now=t*0.001;if(!last)last=now;
  const dt=Math.min(0.033,now-last);last=now;
  update(dt);draw();requestAnimationFrame(loop);
}
function update(dt){
  if(!started)return;
  timeLeft=Math.max(0,timeLeft-dt);
  HUDt.textContent="TIME "+timeLeft.toFixed(1);
  HUDs.textContent="SCORE "+score;
  if(timeLeft<=0){started=false;showCenter("TIME UP!");setTimeout(()=>showCenter("SCORE "+score),1000);}
}
function draw(){
  ctx.clearRect(0,0,W,H);
  // 背景は常に表示
  if(images.bg)ctx.drawImage(images.bg,0,0,W,H);
  // plates
  const r=Math.min(W,H)*0.07,X=[0.17,0.38,0.62,0.83].map(v=>v*W),Yp=H*0.73;
  for(let i=0;i<4;i++){
    ctx.beginPath();ctx.arc(X[i],Yp,r,0,Math.PI*2);
    ctx.fillStyle="#000";ctx.fill();ctx.strokeStyle="#fff";ctx.stroke();
    if(plates[LANES[i]].item&&images.items[plates[LANES[i]].item]){
      ctx.drawImage(images.items[plates[LANES[i]].item],X[i]-r*0.8,Yp-r*0.8,r*1.6,r*1.6);
    }
    ctx.fillStyle="#fff";ctx.textAlign="center";ctx.font="bold 18px sans-serif";
    ctx.fillText(LANES[i],X[i],Yp+r+18);
  }
  // 固定アイコン（A:チョコ B:グミ C:ガム D:アメ）
  const order=['choco','gumi','gum','ame'];
  const Yi=H*0.85, size=W*0.12;
  for(let i=0;i<4;i++){
    const img=images.items[order[i]]; if(!img)continue;
    ctx.drawImage(img,X[i]-size/2,Yi-size/2,size,size);
  }
}
function showCenter(t){center.textContent=t;center.style.opacity=1;setTimeout(()=>center.style.opacity=0,700);}
async function boot(){await loadAll();await runCountdown();startGame();requestAnimationFrame(loop);}
async function runCountdown(){
  for(const txt of ["3","2","1","Shop OPEN!"]){showCenter(txt);await new Promise(r=>setTimeout(r,800));}
}
function startGame(){started=true;timeLeft=60;score=0;equip=null;updateEquipUI();}
boot();
})();
</script>
</body>
</html>
