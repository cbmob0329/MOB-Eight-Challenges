<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>MOB CHALLENGE – 1st Stage (New Game)</title>
<style>
  :root{
    /* === ゲージ白面の内側（ga.png の白）を切り出す微調整 === */
    --gL: 5.0%;    /* 左余白 */
    --gR: 5.0%;    /* 右余白 */
    --gT: 18.0%;   /* 上余白 */
    --gB: 18.0%;   /* 下余白 */
    --guard: 9.5%; /* 右端のマスコット保護（白面右をさらに削る％） */

    /* === スマホ最適化 === */
    --squareSize: min(92vw, 92vh); /* MOBhai の正方形枠サイズ */
    --laneBottom: 13vh;            /* レース時、下部レーンの高さ（UIに被らない） */
    --runnerVW: 9vw;               /* ボールの相対幅（小さめ） */
    --cameraTarget: .40;           /* 画面の何割高さで追従するか（0=上端〜1=下端） */
  }

  html,body{margin:0;height:100%;background:#fff;color:#111;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Sans","Yu Gothic",sans-serif;}
  *{box-sizing:border-box; touch-action:manipulation}
  button{cursor:pointer;border:0;border-radius:14px;background:#111;color:#fff;
    padding:12px 18px;font-weight:800;font-size:clamp(14px,4vw,16px)}

  /* ヘッダ（R数・総合ポイント） */
  #top{position:fixed;left:0;right:0;top:0;height:44px;display:flex;gap:8px;
    align-items:center;justify-content:space-between;padding:0 12px;background:#fff;
    border-bottom:1px solid #e5e7eb;z-index:40}
  #stageInfo{display:flex;gap:10px;font-weight:800;font-size:13px}
  #hint{font-size:12px;opacity:.7}

  /* ======= フェーズA：準備（正方形） ======= */
  #prepare{position:fixed;left:0;right:0;top:44px;bottom:0;display:flex;
    align-items:center;justify-content:center;background:#f4f5f7;z-index:10}
  #sq{width:var(--squareSize);height:var(--squareSize);position:relative;
    background:url('MOBhai.png') center/cover no-repeat;border-radius:16px;
    box-shadow:0 8px 28px rgba(0,0,0,.15);overflow:hidden}
  /* 正方形の中：上にホッケー、中央にゲージ、下に「ゲーム開始」 */
  #sqPucks{position:absolute;left:0;right:0;top:4%;display:flex;gap:8px;
    justify-content:center;flex-wrap:wrap}
  #sqPucks img{width:clamp(40px,10vw,60px);height:auto;image-rendering:pixelated;
    filter:drop-shadow(0 3px 6px rgba(0,0,0,.18))}
  #sqGauges{position:absolute;left:3%;right:3%;top:30%;bottom:18%;
    display:flex;flex-direction:column;gap:1.8vh}
  .sqRow{position:relative;flex:1;display:grid;place-items:center;min-height:64px}
  .sqWrap{position:relative;width:100%;height:100%;display:grid;place-items:center}
  .sqBase{position:absolute;inset:0;background:url('ga.png') center/contain no-repeat;z-index:1}
  .sqInner{position:absolute;inset:var(--gT) calc(var(--gR) + var(--guard)) var(--gB) var(--gL);
    z-index:2;overflow:hidden;border-radius:8px}
  .sqFillBox{position:absolute;left:0;top:0;height:100%;width:0;overflow:hidden}
  .sqFillBox>img{height:100%;width:100%;object-fit:cover;display:block}
  .sqCursor{position:absolute;width:3px;border-radius:2px;background:#111;
    box-shadow:0 0 0 1px #fff;z-index:3;top:var(--gT);bottom:var(--gB);left:var(--gL)}
  .sqRow.inactive .sqCursor{opacity:.35;filter:grayscale(1)}
  #sqStart{position:absolute;left:50%;bottom:5%;transform:translateX(-50%);}

  /* ======= フェーズB：ゲージ（縦長・全画面） ======= */
  #gauge{position:fixed;left:0;right:0;top:44px;bottom:0;display:none;
    background:#eef1f5;padding:1.2vh;z-index:12}
  #gBox{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    width:min(92vw,820px);height:78vh;display:flex;flex-direction:column;gap:1.4vh}
  .gRow{position:relative;flex:1;min-height:110px;display:grid;place-items:center}
  .gWrap{position:relative;width:100%;height:100%;display:grid;place-items:center}
  .gBase{position:absolute;inset:0;background:url('ga.png') center/contain no-repeat;z-index:1}
  .gInner{position:absolute;inset:var(--gT) calc(var(--gR) + var(--guard)) var(--gB) var(--gL);
    z-index:2;overflow:hidden;border-radius:10px}
  .gFillBox{position:absolute;left:0;top:0;height:100%;width:0;overflow:hidden}
  .gFillBox>img{height:100%;width:100%;object-fit:cover;display:block}
  .gCursor{position:absolute;width:3px;border-radius:2px;background:#111;
    box-shadow:0 0 0 1px #fff;z-index:3;top:var(--gT);bottom:var(--gB);left:var(--gL)}
  .gRow.inactive .gCursor{opacity:.35;filter:grayscale(1)}

  /* ======= フェーズC/D：スタンバイ＆レース ======= */
  #worldWrap{ position:fixed; left:0; right:0; top:44px; bottom:0; display:none; z-index:20; }
  #world{
    position:absolute; left:0; right:0; top:0; /* 高さはJSで設定 */
    background-image:url('geji.png');
    background-repeat:repeat-y;
    background-position:center top;
    background-size:100% auto;   /* 横幅でフィット＝映し切る */
    will-change:transform;
    z-index:21;
    transform-style:preserve-3d;
  }
  #lane{
    position:absolute; left:0; right:0; bottom:var(--laneBottom);
    display:flex; gap:min(3vw,14px); justify-content:center;
    z-index:22; pointer-events:none; transform:translateZ(0);
  }
  .runner{ position:relative; z-index:23; transform:translateZ(0); }
  .runner img{ width:min(var(--runnerVW),76px); display:block; image-rendering:pixelated;
               filter:drop-shadow(0 4px 8px rgba(0,0,0,.22)); }
  .name{position:absolute;left:50%;top:calc(100% + 4px);transform:translateX(-50%);
        font-size:clamp(9px,3vw,11px);background:rgba(255,255,255,.9);padding:2px 6px;
        border-radius:999px;border:1px solid #e5e7eb}

  /* カウントダウンやメッセージ */
  #ov{position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,.20);backdrop-filter:blur(1px);z-index:50;pointer-events:none}
  #ov.show{display:flex}
  .toast{font-weight:900;font-size:min(12vw,56px);padding:.3em .7em;background:#fff;
         border:1px solid #e5e7eb;border-radius:14px;color:#111}

  /* 結果カード */
  #result{position:fixed;inset:0;display:none;align-items:center;justify-content:center;
          background:rgba(0,0,0,.25);backdrop-filter:blur(2px);z-index:55}
  #card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:18px 16px;
        width:min(92vw,520px);box-shadow:0 10px 24px rgba(0,0,0,.2)}
  #card h3{margin:0 0 10px}
  #list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px}
  #list li{display:flex;justify-content:space-between;background:#f7f7f8;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px}
  #closeBtn{margin-top:10px;display:flex;justify-content:flex-end}

  /* スタートオーバーレイ（最初だけ） */
  #first{position:fixed;inset:44px 0 0 0;display:flex;align-items:center;justify-content:center;
         background:rgba(255,255,255,.72);backdrop-filter:blur(2px);z-index:35;flex-direction:column;gap:12px}
</style>
</head>
<body>
  <div id="top">
    <div id="stageInfo">Round: <span id="roundNow">1</span> / 3　|　Total: <span id="totalPt">0</span> pt</div>
    <div id="hint">タップ/スペースでストップ（左0〜右100）</div>
  </div>

  <!-- フェーズA：準備（正方形） -->
  <section id="prepare">
    <div id="sq">
      <div id="sqPucks"></div>
      <div id="sqGauges">
        <div class="sqRow" data-i="0"><div class="sqWrap">
          <div class="sqBase"></div>
          <div class="sqInner"><div class="sqFillBox"><img src="tama.png" alt=""></div></div>
          <div class="sqCursor"></div>
        </div></div>
        <div class="sqRow inactive" data-i="1"><div class="sqWrap">
          <div class="sqBase"></div>
          <div class="sqInner"><div class="sqFillBox"><img src="tama.png" alt=""></div></div>
          <div class="sqCursor"></div>
        </div></div>
        <div class="sqRow inactive" data-i="2"><div class="sqWrap">
          <div class="sqBase"></div>
          <div class="sqInner"><div class="sqFillBox"><img src="tama.png" alt=""></div></div>
          <div class="sqCursor"></div>
        </div></div>
      </div>
      <button id="sqStart">ゲーム開始</button>
    </div>
  </section>

  <!-- フェーズB：ゲージ -->
  <section id="gauge">
    <div id="gBox">
      <div class="gRow" data-i="0"><div class="gWrap">
        <div class="gBase"></div>
        <div class="gInner"><div class="gFillBox"><img src="tama.png" alt=""></div></div>
        <div class="gCursor"></div>
      </div></div>
      <div class="gRow inactive" data-i="1"><div class="gWrap">
        <div class="gBase"></div>
        <div class="gInner"><div class="gFillBox"><img src="tama.png" alt=""></div></div>
        <div class="gCursor"></div>
      </div></div>
      <div class="gRow inactive" data-i="2"><div class="gWrap">
        <div class="gBase"></div>
        <div class="gInner"><div class="gFillBox"><img src="tama.png" alt=""></div></div>
        <div class="gCursor"></div>
      </div></div>
    </div>
  </section>

  <!-- フェーズC/D：スタンバイ & レース -->
  <section id="worldWrap">
    <div id="world">
      <div id="lane"></div>
    </div>
  </section>

  <!-- メッセージ / カウントダウン -->
  <div id="ov"><div class="toast" id="ovt"></div></div>

  <!-- 最初のガイダンス -->
  <div id="first">
    <div style="font-size:22px;font-weight:900">MOB CHALLENGE – 1st Stage</div>
    <div style="opacity:.9">赤のホッケーを操作します（全3R）</div>
    <button id="btnGo">OK</button>
  </div>

  <!-- リザルト（各R／総合） -->
  <div id="result"><div id="card">
    <h3 id="rtitle">リザルト</h3>
    <ol id="list"></ol>
    <div id="closeBtn"><button id="btnNext">次へ</button></div>
  </div></div>

<script>
/* ============ 定義 ============ */
const PLAYERS = [
  { id:'red',   name:'赤',   img:'red.png',   control:'human' },
  { id:'blue',  name:'青',   img:'blue.png',  control:'cpu'   },
  { id:'green', name:'緑',   img:'green.png', control:'cpu'   },
  { id:'mura',  name:'紫',   img:'mura.png',  control:'cpu'   },
  { id:'orange',name:'橙',   img:'orange.png',control:'cpu'   },
  { id:'yellow',name:'黄',   img:'yellow.png',control:'cpu'   },
  { id:'black', name:'黒',   img:'black.png', control:'cpu'   },
  { id:'pink',  name:'桃',   img:'pink.png',  control:'cpu'   },
];
const POINTS_PER_RANK=[15,10,7,5,3,1,0,0];
const CPU_SKILL={mean:.70,spread:.20}; // CPUゲージ精度

/* ===== DOM参照 ===== */
const topRound=document.getElementById('roundNow');
const topTotal=document.getElementById('totalPt');
const prepare=document.getElementById('prepare');
const sqPucks=document.getElementById('sqPucks');
const sqRows=[...document.querySelectorAll('.sqRow')];
const sqInners=[...document.querySelectorAll('.sqInner')];
const sqBoxes=[...document.querySelectorAll('.sqFillBox')];
const sqCursors=[...document.querySelectorAll('.sqCursor')];

const gaugeSec=document.getElementById('gauge');
const gRows=[...document.querySelectorAll('.gRow')];
const gInners=[...document.querySelectorAll('.gInner')];
const gBoxes=[...document.querySelectorAll('.gFillBox')];
const gCursors=[...document.querySelectorAll('.gCursor')];

const worldWrap=document.getElementById('worldWrap');
const world=document.getElementById('world');
const lane=document.getElementById('lane');

const first=document.getElementById('first');
const btnGo=document.getElementById('btnGo');
const sqStart=document.getElementById('sqStart');

const ov=document.getElementById('ov');
const ovt=document.getElementById('ovt');

const result=document.getElementById('result');
const rtitle=document.getElementById('rtitle');
const listEl=document.getElementById('list');
const btnNext=document.getElementById('btnNext');

/* ===== 状態 ===== */
let phase='prepare';         // prepare → preCount → gauge → waitOthers → standby → count → shot → rResult → done
let idx=0, cur=0, dir=1, speed=1.2;
let tPrev=0, rafId=0;

let round=1, totalPoint=0, scoreboard=Object.fromEntries(PLAYERS.map(p=>[p.id,0]));
let runners=[];               // {p, el}
const human=PLAYERS[0];       // 赤

/* ===== util ===== */
const clamp=(v,a,b)=>v<a?a:v>b?b:v;
const lerp=(a,b,t)=>a+(b-a)*t;
function randn(mu,s){let u=0,v=0;while(!u)u=Math.random();while(!v)v=Math.random();return mu+s*Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);}

/* ===== 準備：正方形内にマスコットを配置 ===== */
function buildSqPucks(){
  sqPucks.innerHTML='';
  PLAYERS.forEach(p=>{
    const im=document.createElement('img');
    im.src=p.img; im.alt=p.name;
    sqPucks.appendChild(im);
  });
}

/* ===== gauge UI helpers ===== */
function setActiveRows(rows, i){ rows.forEach((r,k)=>r.classList.toggle('inactive',k!==i)); }

/* ga白面内だけで tama.png を露出（rows: 'sq' or 'g'） */
function applyGauge(rowsKey, i, t){
  t=clamp(t,0,1);
  const inn = (rowsKey==='sq'? sqInners[i]: gInners[i]);
  const box = (rowsKey==='sq'? sqBoxes[i] : gBoxes[i]);
  const curEl= (rowsKey==='sq'? sqCursors[i]: gCursors[i]);

  const rect = inn.getBoundingClientRect();
  const w = rect.width * t;

  box.style.width = w+'px';
  const img=box.firstElementChild;
  img.style.width  = rect.width + 'px';
  img.style.height = '100%';

  const cursorX=Math.min(w-1.5, rect.width-1.5);
  curEl.style.left = `calc(var(--gL) + ${Math.max(0,cursorX)}px)`;
}

/* ===== トースト ===== */
function toast(msg, ms=900){
  return new Promise(res=>{
    ovt.textContent=msg; ov.classList.add('show');
    setTimeout(()=>{ ov.classList.remove('show'); setTimeout(res,140);}, ms);
  });
}

/* ===== ラウンド開始セットアップ ===== */
function setupRound(){
  phase='prepare';
  idx=0; cur=0; dir=1; speed=1.2;

  // 正方形UI
  prepare.style.display='flex';
  gaugeSec.style.display='none';
  worldWrap.style.display='none';
  setActiveRows(sqRows,0);
  for(let i=0;i<3;i++) applyGauge('sq', i, 0);

  // CPUプレイヤーの値は後で決定
}

/* ===== カウントダウン（重複防止含む） ===== */
let counting=false;
async function doCountdown(seq=['3','2','1','GO!'], stepMs=600){
  if(counting) return;
  counting=true;
  for(const s of seq){
    ovt.textContent=s; ov.classList.add('show');
    await new Promise(r=>setTimeout(r, stepMs));
  }
  ov.classList.remove('show');
  await new Promise(r=>setTimeout(r,120));
  counting=false;
}

/* ===== フロー ===== */
btnGo.addEventListener('click', ()=>{ first.style.display='none'; });

sqStart.addEventListener('click', async ()=>{
  if(phase!=='prepare') return;
  await toast('ゲージを溜めて威力を上げろ！', 900);
  await doCountdown();
  // ゲージ画面へ
  prepare.style.display='none';
  gaugeSec.style.display='block';
  setActiveRows(gRows,0);
  for(let i=0;i<3;i++) applyGauge('g', i, 0);
  phase='gauge';
});

/* タップ/スペースで止める */
addEventListener('pointerdown', ()=>{
  if(phase==='gauge'){
    stopOne();
  }
},{passive:true});
addEventListener('keydown', e=>{
  if(e.code==='Space'){ e.preventDefault(); if(phase==='gauge') stopOne(); }
});

/* 1本止める */
function stopOne(){
  if(idx>2) return;
  human.values ??= [0,0,0];
  human.values[idx]=cur;
  idx++;
  if(idx<=2){
    setActiveRows(gRows, idx);
    speed += .28;
  }else{
    // 3本完了 → CPUも確定 → そこまで！ → スタンバイへ
    PLAYERS.forEach(p=>{
      if(p!==human){
        p.values=[0,0,0].map(()=>clamp(randn(CPU_SKILL.mean,CPU_SKILL.spread),0,1));
      }
    });
    phase='waitOthers';
    toast('そこまで！', 2000).then(()=>enterStandby());
  }
}

/* スタンバイ（下部に横一列で並べ、背景 geji、視点移動） */
function enterStandby(){
  // 背景高さ（最後まで追従できるように）
  const H=Math.max(innerHeight, document.documentElement.clientHeight);
  // ラウンド距離は端末に依存させず固定寄り（見やすさ）
  WORLD.goalY = 2200;
  world.style.height = (WORLD.goalY + H) + 'px';

  // 画面切替
  gaugeSec.style.display='none';
  worldWrap.style.display='block';
  world.style.transform='translate3d(0,0,0)';

  // 並べる
  lane.innerHTML='';
  runners = PLAYERS.map(p=>{
    const el=document.createElement('div'); el.className='runner';
    el.innerHTML=`<img src="${p.img}" alt=""><div class="name">${p.name}</div>`;
    lane.appendChild(el);
    p._pwr=(p.values[0]+p.values[1]+p.values[2])/3;
    p._y=WORLD.startY; p._t0=0; p._dur=0;
    return {p,el};
  });

  // カウントダウン → レース
  (async()=>{
    await doCountdown();
    startRace();
  })();
}

/* パラメータ（レース） */
const laneBottomPx = (()=> {
  const v = getComputedStyle(document.documentElement).getPropertyValue('--laneBottom').trim();
  const m = v.match(/([\d.]+)vh/);
  const H = Math.max(innerHeight, document.documentElement.clientHeight);
  return m ? (parseFloat(m[1]) * H / 100) : 120;
})();
const WORLD={startY:laneBottomPx, goalY:2200, shotDur:3000};

/* レース開始 */
function startRace(){
  runners.forEach(({p})=>{
    p._t0=performance.now();
    p._dur=lerp(WORLD.shotDur*.6, WORLD.shotDur*1.0, p._pwr);
  });
  phase='shot';
}

/* カメラ追従（赤を画面の40%高さ付近にロック） */
function updateCamera(){
  const red=PLAYERS[0];
  const ratio=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cameraTarget'))||0.40;
  const H=Math.max(innerHeight, document.documentElement.clientHeight);
  const targetY = H * ratio;
  const baseY   = H - laneBottomPx;
  const P       = red._y - WORLD.startY;
  let offsetY   = (targetY - baseY) + P;
  if(offsetY>0) offsetY=0;
  world.style.transform = `translate3d(0,${offsetY}px,0)`;
}

/* ラウンド結果 → 累積ポイント更新 */
function roundResult(){
  const ranking=[...PLAYERS].sort((a,b)=>(b._y||0)-(a._y||0));
  listEl.innerHTML='';
  ranking.forEach((p,i)=>{
    const meters=Math.max(0,(p._y||0)-WORLD.startY)/100;
    const pt=POINTS_PER_RANK[i] ?? 0;
    scoreboard[p.id] += pt;
    const li=document.createElement('li');
    li.innerHTML=`<span>${i+1}位 ${p.name}</span><span>記録 ${meters.toFixed(2)} m　/　+${pt}pt</span>`;
    listEl.appendChild(li);
  });
  // ヘッダの合計ポイントは自分（赤）を表示
  totalPoint = scoreboard['red'];
  topTotal.textContent = totalPoint.toString();
}

/* 総合結果表示 */
function finalResult(){
  const ranking=[...PLAYERS].sort((a,b)=> (scoreboard[b.id] - scoreboard[a.id]));
  listEl.innerHTML='';
  ranking.forEach((p,i)=>{
    const li=document.createElement('li');
    li.innerHTML=`<span>${i+1}位 ${p.name}</span><span>総合 ${scoreboard[p.id]} pt</span>`;
    listEl.appendChild(li);
  });
}

/* ループ */
function loop(t){
  const dt=(tPrev?(t-tPrev):16.6); tPrev=t;

  if(phase==='gauge'){
    cur += (dt/1000)*speed*dir;
    if(cur>=1){cur=1;dir=-1}
    if(cur<=0){cur=0;dir=+1}
    applyGauge('g', idx, cur);
  }

  if(phase==='shot'){
    let allDone=true;
    runners.forEach(({p,el})=>{
      const tt=clamp((t-p._t0)/p._dur,0,1);
      const easeT=(tt<.5)? (2*tt*tt) : (1-Math.pow(-2*tt+2,2)/2);
      p._y = WORLD.startY + (WORLD.goalY - WORLD.startY)*0.98*p._pwr*easeT;
      el.style.transform=`translateY(${-(p._y - WORLD.startY)}px)`;
      if(tt<1) allDone=false;
    });
    updateCamera();
    if(allDone){
      phase='rResult';
      (async()=>{
        await toast('フィニッシュ！', 2000);
        rtitle.textContent = `Round ${round} 結果`;
        roundResult();
        result.style.display='flex';
        btnNext.textContent = (round<3)? '次のラウンドへ' : '総合結果を見る';
      })();
    }
  }

  rafId=requestAnimationFrame(loop);
}
rafId=requestAnimationFrame(loop);

/* 次へ（R進行 or 総合） */
btnNext.addEventListener('click', ()=>{
  result.style.display='none';
  if(round<3){
    round++;
    topRound.textContent = String(round);
    setupRound();
  }else{
    // 総合結果
    rtitle.textContent='総合結果';
    finalResult();
    result.style.display='flex';
    btnNext.textContent='もう一度';
    // もう一度 → リロード相当の再初期化
    btnNext.onclick=()=>location.reload();
  }
});

/* 初期表示 */
buildSqPucks();
setupRound();

/* レイアウト安定のためのリサイズ対応（背景の高さ） */
addEventListener('resize', ()=>{
  if(phase==='standby' || phase==='count' || phase==='shot'){
    const H=Math.max(innerHeight, document.documentElement.clientHeight);
    world.style.height = (WORLD.goalY + H) + 'px';
  }
});
</script>
</body>
</html>
