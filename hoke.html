<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>Hockey Charge Fly</title>
<style>
  :root{
    --ui-bg:#0b0d12; --ui-fg:#fff; --ui-dim:#9aa3b2; --accent:#26d0ff; --accent2:#ff5a8a;
  }
  html,body{margin:0;height:100%;background:#000;color:var(--ui-fg);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif}
  /* 100vhå¯¾ç­–ï¼ˆiOS Safariï¼‰ */
  #app{position:fixed;inset:0;display:flex;flex-direction:column;background:#000}
  #safe{position:relative;flex:1;padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom)}
  #game{position:absolute;inset:0;display:block;width:100%;height:100%;touch-action:none;background:#000}
  /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤UI */
  .overlay{position:fixed;left:0;right:0;display:flex;justify-content:center;pointer-events:none}
  .top{top:calc(env(safe-area-inset-top) + 6px)}
  .center{top:0;bottom:0;align-items:center}
  .bottom{bottom:calc(env(safe-area-inset-bottom) + 14px)}
  .msg{
    background:rgba(10,12,18,.75);backdrop-filter:blur(6px);
    padding:10px 14px;border:1px solid rgba(255,255,255,.2);border-radius:12px;
    font-weight:700;letter-spacing:.02em;box-shadow:0 6px 24px rgba(0,0,0,.35)
  }
  .big{font-size:28px}
  .mid{font-size:20px}
  .small{font-size:14px;color:var(--ui-dim)}
  .distance{
    background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.18);
    border-radius:999px;padding:6px 12px;font-weight:700
  }
  /* ãƒªã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ */
  #restart{
    position:fixed;left:50%;transform:translateX(-50%);
    bottom:calc(env(safe-area-inset-bottom) + 18px);
    background:linear-gradient(180deg,#1f2632,#0f141c);
    color:#fff;border:1px solid #2e394b;border-radius:14px;padding:12px 18px;
    font-weight:700;letter-spacing:.03em;box-shadow:0 10px 28px rgba(0,0,0,.4);
    display:none
  }
  #restart:active{transform:translateX(-50%) scale(.98)}
  /* ã‚²ãƒ¼ã‚¸èª¬æ˜ï¼ˆä¸Šéƒ¨ï¼‰ */
  #hint{display:none}
  /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ */
  #board{
    position:fixed;left:12px;right:12px;top:50%;transform:translateY(-50%);
    background:rgba(9,11,16,.82);backdrop-filter:blur(8px);
    border:1px solid rgba(255,255,255,.15);border-radius:16px;padding:14px;
    display:none;pointer-events:none
  }
  #board h3{margin:0 0 8px 0;font-size:18px}
  #board ol{margin:0;padding-left:18px}
  #board li{margin:6px 0}
</style>
</head>
<body>
<div id="app">
  <div id="safe">
    <canvas id="game"></canvas>
  </div>
</div>

<!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º -->
<div class="overlay center" id="intro"><div class="msg big">ãƒ‘ãƒ¯ãƒ¼ã‚’æºœã‚ã¦é ãã¾ã§é£›ã°ã›ï¼</div></div>
<div class="overlay top" id="hint"><div class="msg small">å·¦åˆ— ä¸Šâ†’ä¸­â†’ä¸‹ â†’ æ¬¡ã«å³åˆ— ä¸Šâ†’ä¸­â†’ä¸‹ï¼ˆå³åˆ—ã¯é›£ã—ã„ï¼‰</div></div>
<div class="overlay center" id="chargeDone"><div class="msg big">ãƒãƒ£ãƒ¼ã‚¸å®Œäº†ï¼</div></div>
<div class="overlay center" id="countdown"><div class="msg big" id="cdText"></div></div>
<div class="overlay top" id="distanceWrap"><div class="distance" id="distText">0.0 m</div></div>
<div class="overlay center" id="record"><div class="msg big" id="recordText">è¨˜éŒ² 0.0 mï¼</div></div>

<button id="restart">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>

<div id="board">
  <h3>é †ä½ç™ºè¡¨</h3>
  <ol id="rankList"></ol>
</div>

<script>
(() => {
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');
  const DPR = Math.max(1, Math.min(window.devicePixelRatio || 1, 3));
  let W=0,H=0;

  // ç”»åƒ
  const bgImg = new Image(); bgImg.src = 'hoke.png';
  const ballImg = new Image(); ballImg.src = 'red.png';

  // ã‚¹ãƒ†ãƒ¼ãƒˆ
  const State = {
    INTRO:'intro', GAUGE:'gauge', CHARGE_DONE:'chargeDone',
    COUNTDOWN:'countdown', FLYING:'flying', STOPPED:'stopped',
    RESULTS:'results', IDLE:'idle'
  };
  let state = State.INTRO;

  // UIè¦ç´ 
  const show = (el, on) => { el.style.display = on ? '' : 'none'; };
  const $intro = document.getElementById('intro');
  const $hint = document.getElementById('hint');
  const $done = document.getElementById('chargeDone');
  const $cd = document.getElementById('countdown');
  const $cdText = document.getElementById('cdText');
  const $distWrap = document.getElementById('distanceWrap');
  const $distText = document.getElementById('distText');
  const $record = document.getElementById('record');
  const $recordText = document.getElementById('recordText');
  const $restart = document.getElementById('restart');
  const $board = document.getElementById('board');
  const $rankList = document.getElementById('rankList');

  // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ & ãƒªã‚µã‚¤ã‚º
  function fit(){
    const rect = cvs.getBoundingClientRect();
    W = Math.floor(rect.width * DPR);
    H = Math.floor(rect.height * DPR);
    cvs.width = W; cvs.height = H;
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';
  }
  addEventListener('resize', fit, {passive:true});
  fit();

  // èƒŒæ™¯ã‚¹ã‚±ãƒ¼ãƒ«ãƒ»ãƒ«ãƒ¼ãƒ—
  let bgScale=1, bgW=0, bgH=0;
  function updateBgScale(){
    if (!bgImg.complete || !bgImg.naturalWidth) return;
    // ç”»é¢ã«åã¾ã‚‹ã‚ˆã†ãƒ•ã‚£ãƒƒãƒˆï¼ˆcoverå¯„ã‚Šã ãŒç¸¦ãƒ«ãƒ¼ãƒ—å‰æï¼‰
    const sw = bgImg.naturalWidth, sh = bgImg.naturalHeight;
    const scale = Math.max(W/sw, H/sh); // ç”»é¢å…¨ä½“ã‚’è¦†ã†
    bgScale = scale;
    bgW = sw*scale; bgH = sh*scale;
  }
  bgImg.onload = updateBgScale;

  // ======= ã‚²ãƒ¼ã‚¸é–¢é€£ =======
  const gauges = []; // 6æœ¬ï¼ˆå·¦3â†’å³3ï¼‰
  const gaugeOrder = [
    {col:0,row:0},{col:0,row:1},{col:0,row:2},
    {col:1,row:0},{col:1,row:1},{col:1,row:2}
  ];
  let currentGaugeIndex = 0;

  function initGauges(){
    gauges.length = 0;
    for(let i=0;i<6;i++){
      const isRight = i>=3;
      gauges.push({
        value: Math.random(), dir: 1,
        speed: isRight ? 1.2 : 0.8, // å³ã¯é€Ÿã„ï¼é›£ã—ã„
        locked: false
      });
    }
    currentGaugeIndex = 0;
  }

  function drawGauges(){
    // ç”»é¢ä¸­å¤®ã«2åˆ—Ã—3è¡Œã®ç¸¦ã‚²ãƒ¼ã‚¸
    const totalW = Math.min(W*0.9, 520*DPR);
    const colGap = 48*DPR, rowGap = 22*DPR;
    const gaugeW = 30*DPR;
    const gaugeH = Math.min(H*0.6, 360*DPR);
    const areaW = gaugeW*2 + colGap;
    const startX = (W - areaW)/2;
    const startY = (H - (gaugeH*3 + rowGap*2))/2;

    for(let i=0;i<6;i++){
      const col = i<3 ? 0 : 1;
      const row = i%3;
      const x = startX + col*(gaugeW + colGap);
      const y = startY + row*(gaugeH + rowGap);

      // èƒŒæ¿
      ctx.fillStyle = 'rgba(255,255,255,0.08)';
      roundRect(ctx, x, y, gaugeW, gaugeH, 12*DPR);
      ctx.fill();

      // ãƒ¡ãƒ¼ã‚¿ãƒ¼å°ç·š
      const pad = 6*DPR;
      const innerX = x+pad, innerY = y+pad, innerW = gaugeW-pad*2, innerH = gaugeH-pad*2;
      ctx.fillStyle = 'rgba(255,255,255,0.12)';
      roundRect(ctx, innerX, innerY, innerW, innerH, 8*DPR);
      ctx.fill();

      // åˆ¤å®šã‚¹ã‚¤ãƒ¼ãƒˆã‚¾ãƒ¼ãƒ³ï¼ˆå³åˆ—ã»ã©ç‹­ã„ï¼‰
      const sweet = (i>=3) ? 0.22 : 0.32;
      const sweetH = innerH * sweet;
      const sweetY = innerY + innerH*(0.5 - sweet/2);
      ctx.fillStyle = 'rgba(38,208,255,0.22)';
      roundRect(ctx, innerX+2*DPR, sweetY, innerW-4*DPR, sweetH, 6*DPR);
      ctx.fill();

      // ç¾åœ¨ä½ç½®ãƒãƒ¼
      const g = gauges[i];
      const cy = innerY + (1-g.value)*innerH;
      ctx.fillStyle = g.locked ? 'rgba(255,90,138,0.9)' : 'rgba(255,255,255,0.9)';
      roundRect(ctx, innerX+3*DPR, cy-4*DPR, innerW-6*DPR, 8*DPR, 4*DPR);
      ctx.fill();

      // æ ï¼†ç•ªå·
      ctx.strokeStyle = (i===currentGaugeIndex) ? '#26d0ff' : 'rgba(255,255,255,0.28)';
      ctx.lineWidth = (i===currentGaugeIndex) ? 3*DPR : 1*DPR;
      roundRect(ctx, x, y, gaugeW, gaugeH, 12*DPR);
      ctx.stroke();

      ctx.fillStyle = 'rgba(255,255,255,0.85)';
      ctx.font = `${12*DPR}px system-ui, sans-serif`;
      ctx.textAlign = 'center'; ctx.textBaseline = 'top';
      ctx.fillText(`${i+1}`, x+gaugeW/2, y-18*DPR);
    }
  }

  function updateGauges(dt){
    for(let i=0;i<6;i++){
      const g = gauges[i];
      if (g.locked) continue;
      // ç¾åœ¨æ“ä½œä¸­ã®ã‚²ãƒ¼ã‚¸ã®ã¿å‹•ã‹ã™
      if (i!==currentGaugeIndex) continue;
      g.value += g.dir * g.speed * dt * 0.5;
      if (g.value>1){ g.value=1; g.dir=-1; }
      if (g.value<0){ g.value=0; g.dir=1; }
    }
  }

  function stopCurrentGauge(){
    const g = gauges[currentGaugeIndex];
    if (!g || g.locked) return;
    g.locked = true;
    currentGaugeIndex++;
    if (currentGaugeIndex>=6){
      // å…¨ç¢ºå®š â†’ ãƒãƒ£ãƒ¼ã‚¸å®Œäº†
      beginChargeDone();
    }
  }

  // ======= é£›è¡Œé–¢é€£ =======
  let ball = null;
  let camY = 0;      // ã‚«ãƒ¡ãƒ©ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é‡ï¼ˆä¸Šå‘ãï¼‰
  let bgScroll = 0;  // èƒŒæ™¯æç”»ç”¨ã‚ªãƒ•ã‚»ãƒƒãƒˆ
  let totalDist = 0; // m
  let countdownT = 0;
  let introTimer = 0;
  let doneTimer = 0;
  let recordTimer = 0;
  let resultsTimer = 0;

  function initBall(){
    const radius = Math.round(Math.min(W,H)*0.045);
    ball = {
      x: W/2,
      y: H*0.72,
      r: radius,
      vy: 0,
      shaking: false
    };
    camY = 0; bgScroll = 0; totalDist = 0;
  }

  function chargePower(){
    // å·¦åˆ—ã¯ã€Œç”˜ã‚ã€ã€å³åˆ—ã¯ã€Œé›£ã—ã„ã€ï¼ã‚¹ã‚¤ãƒ¼ãƒˆã‚¾ãƒ¼ãƒ³ä¸­å¿ƒã«è¿‘ã„ã»ã©é«˜è©•ä¾¡ã«
    // value: 0..1ï¼ˆä¸Š=1ï¼‰
    let score = 0;
    for(let i=0;i<6;i++){
      const v = gauges[i].value;
      const center = 0.5;
      const diff = Math.abs(v - center);
      const tight = (i>=3) ? 0.20 : 0.30; // å³ã¯ç‹­ã„
      const unit = Math.max(0, 1 - diff/(tight));
      // å³åˆ—ã¯é‡ã¿ã‚¢ãƒƒãƒ—
      const weight = (i>=3) ? 1.25 : 1.0;
      score += unit * weight;
    }
    // æœ€å¤§ç†è«–å€¤ = å·¦:3*1.0 + å³:3*1.25 = 6.75
    const norm = Math.min(1, score / 6.75);
    // åˆé€Ÿåº¦ï¼ˆä¸Šï¼‰m/sçš„ãªä»®å€¤ï¼ˆç”»é¢ã‚¹ã‚±ãƒ¼ãƒ«ã«åˆã‚ã›ã‚‹ï¼‰
    const v0 = (H * 0.9) * (0.75 + 1.1*norm); // ç”»é¢é«˜ãƒ™ãƒ¼ã‚¹
    return v0;
  }

  function beginIntro(){
    state = State.INTRO;
    show($intro,true); show($hint,false); show($done,false); show($cd,false);
    show($distWrap,false); show($record,false); $restart.style.display='none'; $board.style.display='none';
    introTimer = 2.0;
    initGauges();
    initBall();
  }

  function beginGauge(){
    state = State.GAUGE;
    show($intro,false); show($hint,true);
  }

  function beginChargeDone(){
    state = State.CHARGE_DONE;
    show($hint,false); show($done,true);
    doneTimer = 2.0;
    // åˆé€Ÿåº¦è¨ˆç®—ã ã‘å…ˆã«
    launchV0 = chargePower();
  }

  function beginCountdown(){
    state = State.COUNTDOWN;
    show($done,false); show($cd,true);
    countdownT = 3.2; // 3â†’2â†’1â†’GO
    ball.shaking = true;
  }

  function beginFlying(){
    state = State.FLYING;
    show($cd,false); show($distWrap,true);
    ball.shaking = false;
    ball.vy = -launchV0; // ä¸Šæ–¹å‘ã‚’è² ã§æ‰±ã†
  }

  function stopAndRecord(){
    state = State.STOPPED;
    show($distWrap,false);
    show($record,true);
    $recordText.textContent = `è¨˜éŒ² ${totalDist.toFixed(1)} mï¼`;
    recordTimer = 2.0;
  }

  function showResults(){
    state = State.RESULTS;
    show($record,false);
    const cpu = makeCPUResults(totalDist);
    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”Ÿæˆ
    const all = [{name:'ã‚ãªãŸ', d:totalDist, you:true}, ...cpu];
    all.sort((a,b)=>b.d-a.d);
    let idx = 1, html='';
    for(const r of all){
      const mark = r.you ? 'ğŸ‘‘' : '';
      html += `<li>${idx}. ${r.you?'<b>ã‚ãªãŸ</b>':`CPU${r.id}`} â€” <b>${r.d.toFixed(1)} m</b> ${mark}</li>`;
      idx++;
    }
    $rankList.innerHTML = html;
    $board.style.display = '';
    resultsTimer = 3.0;
  }

  function showRestart(){
    $restart.style.display = 'block';
  }

  function makeCPUResults(playerDist){
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä¸­å¿ƒã«Â±20%ç¨‹åº¦ã§4äººä½œæˆ
    const arr = [];
    for(let i=1;i<=4;i++){
      const delta = (Math.random()*0.4 - 0.2); // -20%..+20%
      const d = Math.max(5, playerDist * (1 + delta));
      arr.push({id:i, d});
    }
    return arr;
  }

  // å…¥åŠ›
  function onTap(){
    if (state===State.GAUGE){
      stopCurrentGauge();
    }
  }
  cvs.addEventListener('pointerdown', onTap);

  // ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
  $restart.addEventListener('click', ()=>{
    beginIntro();
  });

  // ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
  let last = performance.now();
  let launchV0 = 0;

  function loop(now){
    const dt = Math.min(0.033, (now - last)/1000);
    last = now;
    updateBgScale();
    ctx.clearRect(0,0,W,H);

    // èƒŒæ™¯æç”»ï¼ˆç¸¦ãƒ«ãƒ¼ãƒ—ï¼‰
    drawBg();

    switch(state){
      case State.INTRO:
        drawBallAtRest();
        introTimer -= dt;
        if (introTimer<=0) beginGauge();
        break;

      case State.GAUGE:
        updateGauges(dt);
        drawGauges();
        drawBallAtRest();
        break;

      case State.CHARGE_DONE:
        drawBallAtRest();
        doneTimer -= dt;
        if (doneTimer<=0) beginCountdown();
        break;

      case State.COUNTDOWN:
        // éœ‡ãˆã‚¢ãƒ‹ãƒ¡
        drawBallAtRest(true);
        countdownT -= dt;
        renderCountdown(countdownT);
        if (countdownT<=0) beginFlying();
        break;

      case State.FLYING:
        updateFlight(dt);
        drawFlight();
        break;

      case State.STOPPED:
        drawFlight(true);
        recordTimer -= dt;
        if (recordTimer<=0) showResults();
        break;

      case State.RESULTS:
        drawFlight(true);
        resultsTimer -= dt;
        if (resultsTimer<=0) showRestart();
        break;
    }

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // ======= æç”»ãƒ˜ãƒ«ãƒ‘ =======
  function drawBg(){
    if (!bgW || !bgH){ ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H); return; }
    // ã‚«ãƒ¡ãƒ©Yã«åˆã‚ã›ã¦ä¸‹æ–¹å‘ã¸æµã™ï¼ˆãƒœãƒ¼ãƒ«ä¸Šæ˜‡ã®è¦‹ãŸç›®ï¼‰
    // ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’æ­£æ–¹å‘ã§å¢—ã‚„ã—ã€ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’ä¸‹ã‹ã‚‰ä¸Šã¸é€ã‚‹
    const offset = (bgScroll % bgH + bgH) % bgH;
    // 2æšã§ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹
    ctx.drawImage(bgImg, 0, -offset, bgW, bgH);
    ctx.drawImage(bgImg, 0, -offset + bgH, bgW, bgH);
    // ä½™ç™½ãŒå‡ºãªã„ã‚ˆã†æ¨ªæ•´åˆ—ï¼ˆä¸­å¤®å¯„ã›ï¼‰
    // æ—¢ã« bgW==W ã«ãªã‚‹ã‚ˆã†ã« scale è¨­å®šã—ã¦ã„ã‚‹ãŒã€å¾®å°èª¤å·®ã¯å¡—ã‚Šã§éš ã™
    if (bgW<W){
      ctx.fillStyle='#000';
      const pad = Math.floor((W-bgW)/2);
      ctx.fillRect(0,0,pad,H); ctx.fillRect(W-pad,0,pad,H);
    }
  }

  function drawBallAtRest(shake=false){
    const x = ball.x;
    const y = ball.y;
    let dx=0, dy=0;
    if (shake){
      dx = (Math.random()*2-1) * ball.r*0.08;
      dy = (Math.random()*2-1) * ball.r*0.08;
    }
    drawBall(x+dx, y+dy, ball.r);
  }

  function drawBall(x,y,r){
    if (ballImg.complete && ballImg.naturalWidth){
      const scale = (r*2)/Math.max(ballImg.naturalWidth, ballImg.naturalHeight);
      const w = ballImg.naturalWidth*scale;
      const h = ballImg.naturalHeight*scale;
      ctx.drawImage(ballImg, x-w/2, y-h/2, w, h);
    }else{
      ctx.fillStyle='#e33';
      ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
    }
  }

  function renderCountdown(t){
    let text='';
    if (t>2) text='3';
    else if (t>1) text='2';
    else if (t>0) text='1';
    else text='GO!';
    $cdText.textContent = text;
  }

  function updateFlight(dt){
    // ç°¡æ˜“ç‰©ç†ï¼šä¸Šå‘ãè² ã€é‡åŠ›ã¯æ­£
    const g = H * 0.9; // ç”»é¢é«˜åŸºæº–ã®é‡åŠ›æ„Ÿ
    // ç©ºæ°—æŠµæŠ—çš„ãªæ¸›è¡°
    const drag = 0.12;
    ball.vy += g * dt;      // åŠ é€Ÿåº¦ï¼ˆä¸‹å‘ãï¼‰
    ball.vy += ball.vy * drag * dt; // æ¸›è¡°ï¼ˆä¸Šå‘ãã®é€Ÿåº¦ã‚’æ—©ãå¤±ã‚ã›ã‚‹ï¼‰
    ball.y += ball.vy * dt;

    // ã‚«ãƒ¡ãƒ©è¿½å¾“ï¼šãƒœãƒ¼ãƒ«ãŒç”»é¢ä¸‹60%ã‚ˆã‚Šä¸Šã«æ¥ãŸã‚‰ä¸Šæ–¹å‘ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    const followY = H*0.4;
    if (ball.y < followY){
      const dy = followY - ball.y;
      ball.y += dy;
      camY += dy;
      bgScroll += dy; // èƒŒæ™¯ã‚‚åŒé‡ã ã‘æµã™ï¼ˆç¸¦ãƒ«ãƒ¼ãƒ—ï¼‰
      totalDist += dy / (100*DPR); // mæ›ç®—ï¼ˆé©åº¦ã«ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
      // è·é›¢è¡¨ç¤ºæ›´æ–°
      $distText.textContent = `${totalDist.toFixed(1)} m`;
    }

    // é ‚ç‚¹ã§åœæ­¢ï¼šä¸Šå‘ãï¼ˆvy<0ï¼‰ã‹ã‚‰ä¸‹å‘ãã¸è»¢ã˜ãŸç¬é–“ã«çµ‚äº†
    if (ball.vy >= 0){
      ball.vy = 0;
      stopAndRecord();
    }
  }

  function drawFlight(freeze=false){
    // ãƒœãƒ¼ãƒ«æç”»
    drawBall(ball.x, ball.y, ball.r);

    // è·é›¢è¡¨ç¤ºä½ç½®ï¼ˆãƒœãƒ¼ãƒ«ã¨è¢«ã‚‰ãªã„ã‚ˆã†ã«ä¸­å¤®ã‚„ã‚„ä¸Šã€è·é›¢UIã¯DOMã§ä½ç½®å›ºå®šï¼‰
    // DOMã®è·é›¢ãƒãƒƒã‚¸ã¯ç”»é¢ä¸Šéƒ¨ã‚»ãƒ³ã‚¿ãƒ¼å›ºå®šã€‚ãƒœãƒ¼ãƒ«ãŒé‡ãªã‚‹å ´åˆã¯DOMã‚’å°‘ã—ä¸‹ã’ãŸã„ãŒã€
    // é‡ãªã‚Šå›é¿ã¨ã—ã¦ååˆ†ä½™ç™½ï¼ˆä¸Šéƒ¨ï¼‰ã«é…ç½®ã—ã¦ã„ã‚‹ãŸã‚ã“ã“ã§ã¯çœç•¥ã€‚

    if (freeze){
      // åœæ­¢ä¸­ã¯è»½ã„ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      ctx.strokeStyle='rgba(255,255,255,0.35)';
      ctx.lineWidth = 2*DPR;
      ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r*1.25, 0, Math.PI*2); ctx.stroke();
    }
  }

  // è§’ä¸¸çŸ©å½¢
  function roundRect(c, x,y,w,h,r){
    c.beginPath();
    c.moveTo(x+r,y);
    c.arcTo(x+w,y,x+w,y+h,r);
    c.arcTo(x+w,y+h,x,y+h,r);
    c.arcTo(x,y+h,x,y,r);
    c.arcTo(x,y,x+w,y,r);
    c.closePath();
  }

  // ã‚²ãƒ¼ãƒ é–‹å§‹
  let started = false;
  function kickstart(){
    if (started) return;
    started = true;
    beginIntro();
  }
  document.addEventListener('visibilitychange', ()=>{ if (document.visibilityState==='visible') fit(); });
  window.addEventListener('load', kickstart);

  // ã‚¿ã‚¤ãƒãƒ¼çš„ã«é·ç§»
  function stepTimers(dt){
    if (state===State.INTRO){
      // handled in loop
    } else if (state===State.COUNTDOWN){
      // handled in loop
    }
  }

  // ãƒ¡ã‚¤ãƒ³é–‹å§‹æ¸ˆã¿
})();
</script>
</body>
</html>
