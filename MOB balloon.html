<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
<title>MOB balloon</title>
<meta name="theme-color" content="#0b0c10" />
<style>
  :root{
    --bg:#0b0c10; --panel:#121621; --panel2:#171c2a; --fg:#e9eef7; --dim:#9aa3b2;
    --accent:#13c4ff; --accent2:#ff3e7f;
  }
  html,body{
    height:100%; margin:0; background:var(--bg); color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Sans","Yu Gothic",sans-serif;
    -webkit-touch-callout:none; -webkit-user-select:none; user-select:none;
    touch-action:manipulation;
  }
  #app-wrap{ position:fixed; inset:0; display:grid; place-items:center; }

  #phone{
    width:390px; height:780px;
    background:linear-gradient(160deg,#0b0c10,#0e1220 60%,#0b0c10);
    border-radius:24px;
    box-shadow:0 10px 40px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.06);
    overflow:hidden;
    display:flex; flex-direction:column;
  }
  #topbar{
    flex:0 0 48px; display:flex; align-items:center; justify-content:space-between;
    padding:0 12px; background:var(--panel);
    border-bottom:1px solid rgba(255,255,255,.06);
    font-weight:600;
  }
  #hud{ display:flex; gap:10px; font-size:12px; color:var(--dim); }
  #hud b{ color:var(--fg); }

  #stage-wrap{ flex:1; display:flex; justify-content:center; align-items:center; background:var(--panel2); padding:4px; }
  #stage{ width:94%; aspect-ratio:1/1; background:#000; border-radius:12px; position:relative; }
  canvas{ width:100%; height:100%; display:block; border-radius:12px; image-rendering:pixelated; }

  .overlay{ position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; }
  .center-panel{ background:rgba(10,12,20,.85); border-radius:14px; padding:18px; width:85%; max-width:320px; text-align:center; pointer-events:auto; }
  .title{ font-size:22px; font-weight:800; margin-bottom:6px; }
  .sub{ font-size:12px; color:var(--dim); margin-bottom:14px; }
  .btn{ padding:12px; border:none; border-radius:12px; background:var(--accent); font-weight:800; width:100%; }
  .counter{ font-size:56px; font-weight:900; }

  #legend{ flex:0 0 48px; display:flex; justify-content:center; align-items:center; font-size:12px; color:#cfe7ff; background:var(--panel); }
</style>
</head>
<body>
<div id="app-wrap">
  <div id="phone">
    <div id="topbar">
      <div>MOB balloon</div>
      <div id="hud">
        <span>R:<b id="roundNum">1</b>/3</span>
        <span>生存:<b id="alive">8</b></span>
        <span>時間:<b id="time">0.0</b>s</span>
        <span id="speedTag">通常</span>
      </div>
    </div>

    <div id="stage-wrap">
      <div id="stage">
        <canvas id="cv" width="1000" height="1000"></canvas>

        <div class="overlay" id="startOverlay">
          <div class="center-panel">
            <div class="title">MOB balloon</div>
            <div class="sub">画面をタップして移動！カラスから逃げ続けよう</div>
            <button class="btn" id="btnStart">ゲームスタート</button>
          </div>
        </div>
        <div class="overlay" id="countOverlay" style="display:none;">
          <div class="counter" id="countLabel">3</div>
        </div>
        <div class="overlay" id="roundOverlay" style="display:none;">
          <div class="center-panel"><div class="title">ラウンド終了</div></div>
        </div>
        <div class="overlay" id="finalOverlay" style="display:none;">
          <div class="center-panel"><div class="title">総合結果</div></div>
        </div>
      </div>
    </div>

    <div id="legend">画面タップで移動</div>
  </div>
</div>

<script>
const ASSETS = {
  bg:"MOBhai.png", crowR:"karasu1.png", crowL:"karasu2.png",
  balloons:{Red:"Redb.png", Blue:"Buleb.png", Green:"Greenb.png", Purple:"murab.png", Orange:"Orangeb.png", Pink:"Pinkb.png", Yellow:"yellowb.png", Black:"Blackb.png"}
};
const cv=document.getElementById("cv"),ctx=cv.getContext("2d");
const btnStart=document.getElementById("btnStart"),startOverlay=document.getElementById("startOverlay"),countOverlay=document.getElementById("countOverlay"),countLabel=document.getElementById("countLabel");
const aliveEl=document.getElementById("alive"),timeEl=document.getElementById("time"),roundNumEl=document.getElementById("roundNum"),speedTag=document.getElementById("speedTag");

const STAGE=1000;
let images={},ready=false,player=null,balloons=[],crows=[],gameTime=0,playing=false,counting=false,simSpeed=1;

class Balloon{constructor(isPlayer){this.x=500;this.y=500;this.vx=0;this.vy=0;this.ax=0;this.ay=0;this.r=26;this.alive=true;this.isPlayer=isPlayer;this.popping=false;this.popT=0;this.target=null;}}
class Crow{constructor(){this.x=Math.random()*STAGE;this.y=Math.random()*STAGE;this.size=52;this.vx=0;this.vy=0;this.speed=95;this.dirR=true;}}

function loadImage(src){return new Promise(res=>{let i=new Image();i.onload=()=>res(i);i.src=src;});}
async function loadAssets(){for(const [k,v] of Object.entries(ASSETS)){if(typeof v==="string"){images[k]=await loadImage(v);}else{for(const [kk,vv] of Object.entries(v)){images[kk]=await loadImage(vv);}}}ready=true;}

function resetRound(){balloons=[];player=new Balloon(true);balloons.push(player);for(let i=0;i<7;i++)balloons.push(new Balloon(false));crows=[new Crow()];gameTime=0;simSpeed=1;playing=false;counting=false;}

function startCountdown(){counting=true;startOverlay.style.display="none";countOverlay.style.display="grid";let seq=[3,2,1,"GO"],i=0;function tick(){countLabel.textContent=seq[i++];if(i<seq.length)setTimeout(tick,700);else setTimeout(()=>{countOverlay.style.display="none";playing=true;counting=false;},400);}tick();}

function step(dt){
 if(!playing)return;
 if(!player.alive){simSpeed=3;speedTag.textContent="高速×3";}
 dt*=simSpeed;gameTime+=dt;

 // プレイヤー制御
 if(player.alive && player.target){
   const dx=player.target.x-player.x,dy=player.target.y-player.y,dist=Math.hypot(dx,dy);
   if(dist>5){player.ax=dx/dist*520;player.ay=dy/dist*520;}else{player.ax=0;player.ay=0;}
 }

 // CPU
 balloons.forEach(b=>{if(!b.isPlayer&&b.alive){b.ax=(Math.random()*2-1)*420;b.ay=(Math.random()*2-1)*420;}});

 // 速度更新
 const vmax=640,drag=0.94;
 balloons.forEach(b=>{
   if(!b.alive)return;
   b.vx=(b.vx+b.ax*dt)*drag; b.vy=(b.vy+b.ay*dt)*drag;
   let sp=Math.hypot(b.vx,b.vy); if(sp>vmax){b.vx=b.vx/sp*vmax; b.vy=b.vy/sp*vmax;}
   b.x+=b.vx*dt; b.y+=b.vy*dt;
   if(b.x<b.r)b.x=b.r; if(b.x>STAGE-b.r)b.x=STAGE-b.r;
   if(b.y<b.r)b.y=b.r; if(b.y>STAGE-b.r)b.y=STAGE-b.r;
 });

 timeEl.textContent=gameTime.toFixed(1);
}

function draw(){
 ctx.clearRect(0,0,STAGE,STAGE);
 if(images.bg)ctx.drawImage(images.bg,0,0,STAGE,STAGE); else{ctx.fillStyle="#333";ctx.fillRect(0,0,STAGE,STAGE);}
 balloons.forEach(b=>{if(!b.alive)return;ctx.fillStyle=b.isPlayer?"red":"blue";ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,Math.PI*2);ctx.fill();});
}

let last=0;function loop(t){if(!ready){requestAnimationFrame(loop);return;}let now=t/1000,dt=now-last||0.016;last=now;step(dt);draw();requestAnimationFrame(loop);}loadAssets().then(()=>requestAnimationFrame(loop));

btnStart.onclick=()=>{resetRound();startCountdown();};
cv.addEventListener("touchstart",e=>{let r=cv.getBoundingClientRect(),x=(e.touches[0].clientX-r.left)/r.width*STAGE,y=(e.touches[0].clientY-r.top)/r.height*STAGE;player.target={x,y};},{passive:false});
cv.addEventListener("touchmove",e=>{let r=cv.getBoundingClientRect(),x=(e.touches[0].clientX-r.left)/r.width*STAGE,y=(e.touches[0].clientY-r.top)/r.height*STAGE;player.target={x,y};},{passive:false});
cv.addEventListener("touchend",()=>{player.target=null;});
</script>
</body>
</html>
