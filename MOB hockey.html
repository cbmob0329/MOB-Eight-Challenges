<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>Balloon Smash 30 ‚Äì È¢®ËàπÂÆåÂÖ®ÂÅúÊ≠¢Áâà</title>
<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden}
  canvas{position:fixed;inset:0;display:block;width:100%;height:100%;touch-action:none}

  /* HUD */
  #hud{
    position:fixed; top:0; left:0; right:0; z-index:30;
    display:flex; gap:8px; justify-content:space-between; align-items:center;
    padding:8px 12px; color:#fff; font-family:system-ui,-apple-system,"Hiragino Sans","Yu Gothic",sans-serif;
    background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.15));
    -webkit-user-select:none; user-select:none;
  }
  .pill{background:#0f172a; border:1px solid #263040; border-radius:999px; padding:6px 10px; font-weight:800; min-width:92px; text-align:center}
  #start, #restart{
    appearance:none; border:1px solid #264861; border-radius:12px; padding:10px 14px;
    background:#0b2b3d; color:#dff3ff; font-weight:900;
  }
  #restart{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; z-index:30; display:none; }

  /* „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥/ÁµÇ‰∫ÜË°®Á§∫Ôºà„Éú„Çø„É≥Êìç‰Ωú„ÇíÈÇ™È≠î„Åó„Å™„ÅÑÔºâ */
  #overlay{
    position:fixed; inset:0; z-index:15; display:flex; align-items:center; justify-content:center;
    font-size:14vw; font-weight:900; color:#fff; text-shadow:0 0 18px rgba(0,0,0,.75);
    pointer-events:none; text-align:center; line-height:1.1;
  }
  @media (min-width:540px){ #overlay{font-size:72px} }

  /* „Ç≤„Éº„Ç∏UI */
  #gaugeWrap{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:10px; width:min(86vw, 520px); height:16px; border-radius:10px; overflow:hidden;
    background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15); z-index:20; display:none;
  }
  #gaugeFill{height:100%; width:0%; background:linear-gradient(90deg,#1ad1ff,#5cfcc3);}

  /* „Éí„É≥„Éà */
  #angleHint{
    position:fixed; left:50%; transform:translateX(-50%); bottom:34px;
    color:#cbd5e1; font-size:12px; font-weight:700; font-family:system-ui,-apple-system,"Hiragino Sans","Yu Gothic",sans-serif;
    text-shadow:0 2px 6px rgba(0,0,0,.5); z-index:20; display:none;
  }
</style>
</head>
<body>
  <div id="hud">
    <div class="pill" id="timePill">TIME 30.0</div>
    <div class="pill" id="scorePill">SCORE 0</div>
    <button id="start">‚ñ∂ START</button>
  </div>

  <canvas id="cv"></canvas>
  <div id="overlay"></div>
  <button id="restart">üîÅ „É™„Çπ„Çø„Éº„Éà</button>

  <div id="angleHint">ÁîªÈù¢„Çí„Çø„ÉÉ„Éó„Åó„Å¶ËßíÂ∫¶„ÇíÊ±∫„ÇÅ„ÄÅÊäº„ÅóÁ∂ö„Åë„Å¶„Ç≤„Éº„Ç∏„ÄÅÈõ¢„Åó„Å¶„Ç∑„Éß„ÉÉ„ÉàÔºÅ</div>
  <div id="gaugeWrap"><div id="gaugeFill"></div></div>

<script>
/* ========= Âü∫Êú¨„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó ========= */
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d', { alpha:false });
const overlay = document.getElementById('overlay');
const timeP = document.getElementById('timePill');
const scoreP = document.getElementById('scorePill');
const startBtn = document.getElementById('start');
const restartBtn = document.getElementById('restart');
const gaugeWrap = document.getElementById('gaugeWrap');
const gaugeFill = document.getElementById('gaugeFill');
const angleHint = document.getElementById('angleHint');

const DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
let W=0, H=0;
function resize(){ W=cv.clientWidth; H=cv.clientHeight; cv.width=Math.floor(W*DPR); cv.height=Math.floor(H*DPR); ctx.setTransform(DPR,0,0,DPR,0,0); }
addEventListener('resize', resize, {passive:true}); resize();

/* ========= ÁîªÂÉèÔºàÁÑ°„Åè„Å¶„ÇÇ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„ÅßÊèèÁîªÔºâ ========= */
function loadImage(src){ return new Promise(r=>{ const img=new Image(); img.onload=()=>r(img); img.onerror=()=>r(null); img.src=src; }); }
const assets = { bg:null, ball:null, balloon:null };
(async ()=>{ assets.bg=await loadImage('MOBhai.png'); assets.ball=await loadImage('red.png'); assets.balloon=await loadImage('Redb.png'); })();

/* ========= Áâ©ÁêÜ„Éª„É´„Éº„É´ ========= */
const GAME_TIME=30.0, BALLOON_COUNT=30;
const WALL={L:10, R:()=>W-10, B:()=>H-10};
function SHOOT_ORIGIN(){ return {x: W*0.5, y: H*0.88}; }
const BALL_R=16, FRICTION=0.994, STOP_SPEED=25, POP_SPEED=220;
const POWER_MIN=420, POWER_MAX=1200, CHARGE_TIME=1200; // ms

/* ========= Áä∂ÊÖã ========= */
let running=false, finished=false, lastTs=0, timeLeft=GAME_TIME, score=0;
let balloons=[], needResetAfterExit=false;
let ball={x:0,y:0,vx:0,vy:0,r:BALL_R};
let aiming=false, aimAngle=-Math.PI/2, chargeStart=0;

/* ========= CPUÔºà„ÉÄ„Éü„ÉºÔºâ ========= */
const cpuNames=['CPU-1','CPU-2','CPU-3','CPU-4','CPU-5','CPU-6','CPU-7'];
let cpuScores={}, cpuSkill={};
function initCPU(){ cpuScores={}; cpuSkill={}; cpuNames.forEach(n=>{ const base=0.6+Math.random()*0.7, clutch=0.15+Math.random()*0.35; cpuSkill[n]={base,clutch}; cpuScores[n]=0; }); }
function updateCPU(dt){ const p=1-(timeLeft/GAME_TIME); for(const n of cpuNames){ const rate=cpuSkill[n].base+cpuSkill[n].clutch*p; const expected=dt*rate; const burst=Math.random()<expected*0.35?1:0; cpuScores[n]+=(expected+burst); }}

/* ========= ÂàùÊúüÂåñ ========= */
function resetLevel(){
  balloons.length=0;
  for(let i=0;i<BALLOON_COUNT;i++){
    const r=16+Math.random()*6;
    const x=WALL.L+r+Math.random()*(WALL.R()-WALL.L-r*2);
    const y=20+r+Math.random()*((H*0.60)-r*2);
    balloons.push({x,y,r,alive:true}); // ‚Üê ‰ΩçÁΩÆ„ÅØÂõ∫ÂÆö„ÄÇ‰ª•Âæå‰∏ÄÂàáÊõ¥Êñ∞„Åó„Å™„ÅÑ
  }
  const o=SHOOT_ORIGIN(); ball.x=o.x; ball.y=o.y-40; ball.vx=0; ball.vy=0;
  needResetAfterExit=false;
}
function fullReset(){ score=0; timeLeft=GAME_TIME; finished=false; running=false; lastTs=0; initCPU(); resetLevel(); updateHUD(); }
fullReset();
function updateHUD(){ timeP.textContent=`TIME ${timeLeft.toFixed(1)}`; scoreP.textContent=`SCORE ${score}`; }

/* ========= ÂÖ•ÂäõÔºàËßíÂ∫¶„É©„Ç§„É≥Ôºã„Ç≤„Éº„Ç∏Ôºâ ========= */
function canvasPoint(e){ const r=cv.getBoundingClientRect(); return {x:e.clientX-r.left, y:e.clientY-r.top}; }
cv.addEventListener('pointerdown', (e)=>{
  if(!running||finished) return;
  aiming=true; angleHint.style.display='block'; gaugeWrap.style.display='block';
  const p=canvasPoint(e), o=SHOOT_ORIGIN(); let ang=Math.atan2(p.y-o.y,p.x-o.x);
  const minAng=-Math.PI*0.95, maxAng=-Math.PI*0.05; ang=Math.max(minAng,Math.min(maxAng,ang));
  aimAngle=ang; chargeStart=performance.now(); gaugeFill.style.width='0%';
});
cv.addEventListener('pointermove', (e)=>{
  if(!aiming) return;
  const p=canvasPoint(e), o=SHOOT_ORIGIN(); let ang=Math.atan2(p.y-o.y,p.x-o.x);
  const minAng=-Math.PI*0.95,maxAng=-Math.PI*0.05; if(ang<minAng) ang=minAng; if(ang>maxAng) ang=maxAng; aimAngle=ang;
});
addEventListener('pointerup', ()=>{
  if(!aiming) return;
  aiming=false; angleHint.style.display='none'; gaugeWrap.style.display='none';
  const t=performance.now()-chargeStart, rate=Math.max(0,Math.min(1,t/CHARGE_TIME));
  const power=POWER_MIN+(POWER_MAX-POWER_MIN)*rate; ball.vx=Math.cos(aimAngle)*power; ball.vy=Math.sin(aimAngle)*power;
});

/* ========= Áâ©ÁêÜ ========= */
function reflectWalls(){
  if(ball.x-ball.r<WALL.L){ ball.x=WALL.L+ball.r; ball.vx*=-1; }
  if(ball.x+ball.r>WALL.R()){ ball.x=WALL.R()-ball.r; ball.vx*=-1; }
  if(ball.y+ball.r>WALL.B()){ ball.y=WALL.B()-ball.r; ball.vy*=-1; }
  if(ball.y+ball.r<0){ needResetAfterExit=true; }
}
function hitBalloons(){
  const sp2=ball.vx*ball.vx+ball.vy*ball.vy, need=POP_SPEED*POP_SPEED;
  for(const b of balloons){
    if(!b.alive) continue;
    const d=Math.hypot(ball.x-b.x, ball.y-b.y);
    if(d<ball.r+b.r){ if(sp2>=need){ b.alive=false; score++; } }
  }
}

/* ========= „É´„Éº„Éó ========= */
function step(ts){
  if(!lastTs) lastTs=ts;
  const dt=Math.min(0.05,(ts-lastTs)/1000); lastTs=ts;

  if(running && !finished){
    timeLeft=Math.max(0,timeLeft-dt); updateCPU(dt);

    // ÁêÉ„ÅÆ„ÅøÊõ¥Êñ∞„ÄÇÈ¢®Ëàπ„ÅØ‰∏ÄÂàáÊõ¥Êñ∞„Åó„Å™„ÅÑ„ÄÇ
    ball.x+=ball.vx*dt; ball.y+=ball.vy*dt;

    reflectWalls();
    hitBalloons();

    ball.vx*=FRICTION; ball.vy*=FRICTION;

    const speed=Math.hypot(ball.vx,ball.vy);
    if(speed<STOP_SPEED || needResetAfterExit){ resetLevel(); } // „É™„Çª„ÉÉ„Éà„Åß‰ΩçÁΩÆ„Å†„ÅëÂÜçÈÖçÂàó
    if(timeLeft<=0){ finishGame(); }
    updateHUD();
  }

  render();
  requestAnimationFrame(step);
}
requestAnimationFrame(step);

/* ========= ÊèèÁîª ========= */
function drawBackground(){
  if(assets.bg){ const iw=assets.bg.width, ih=assets.bg.height, rImg=iw/ih, rCv=W/H;
    let dw,dh; if(rImg>rCv){ dh=H; dw=dh*rImg; } else { dw=W; dh=dw/rImg; }
    const dx=(W-dw)/2, dy=(H-dh)/2; ctx.drawImage(assets.bg,dx,dy,dw,dh);
  }else{ const g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#0e1322'); g.addColorStop(1,'#070b13'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H); }
}
function drawWalls(){
  ctx.fillStyle='rgba(12,25,45,0.90)';
  ctx.fillRect(0,0,WALL.L,H); ctx.fillRect(WALL.R(),0,W-WALL.R(),H); ctx.fillRect(0,WALL.B(),W,H-WALL.B());
  ctx.fillStyle='rgba(42,58,98,0.55)'; ctx.fillRect(WALL.L-3,0,3,H); ctx.fillRect(WALL.R(),0,3,H); ctx.fillRect(0,WALL.B(),W,3);
}
function drawBalloon(b){
  if(!b.alive) return;
  if(assets.balloon){ const d=b.r*2; ctx.drawImage(assets.balloon,b.x-b.r,b.y-b.r,d,d); }
  else{ const g=ctx.createRadialGradient(b.x-4,b.y-6,4,b.x,b.y,b.r); g.addColorStop(0,'#ffb3b3'); g.addColorStop(1,'#c1121f');
        ctx.fillStyle=g; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
        ctx.fillStyle='rgba(255,255,255,.35)'; ctx.beginPath(); ctx.ellipse(b.x-6,b.y-8, b.r*0.35, b.r*0.22, -0.6, 0, Math.PI*2); ctx.fill(); }
}
function drawBall(){
  const {x,y,r}=ball;
  if(assets.ball){ ctx.drawImage(assets.ball,x-r,y-r,r*2,r*2); }
  else{ ctx.fillStyle='#ef4444'; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }
}
function drawAimLine(){
  if(!aiming) return;
  const o=SHOOT_ORIGIN(); const t=performance.now()-chargeStart;
  const rate=Math.max(0,Math.min(1,t/CHARGE_TIME));
  const len=160+60*rate, ex=o.x+Math.cos(aimAngle)*len, ey=o.y+Math.sin(aimAngle)*len;
  ctx.save(); ctx.lineWidth=3; ctx.strokeStyle='rgba(19,196,255,0.9)'; ctx.fillStyle='rgba(19,196,255,0.25)';
  ctx.beginPath(); ctx.moveTo(o.x,o.y); ctx.lineTo(ex,ey); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(ex,ey);
  ctx.lineTo(ex-12*Math.cos(aimAngle-0.3), ey-12*Math.sin(aimAngle-0.3));
  ctx.lineTo(ex-12*Math.cos(aimAngle+0.3), ey-12*Math.sin(aimAngle+0.3));
  ctx.closePath(); ctx.fill(); ctx.restore();
  gaugeFill.style.width=`${rate*100}%`;
}
function render(){
  ctx.clearRect(0,0,W,H);
  drawBackground(); drawWalls();
  for(const b of balloons) drawBalloon(b);
  drawBall(); drawAimLine();
  const o=SHOOT_ORIGIN(); ctx.fillStyle='rgba(255,255,255,.18)'; ctx.beginPath(); ctx.arc(o.x, o.y, 10, 0, Math.PI*2); ctx.fill();
}

/* ========= „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ÔºàÁ¢∫ÂÆüÂÆüË°åÔºâ ========= */
function countdownThen(startCb){
  overlay.textContent='3';
  setTimeout(()=>{ overlay.textContent='2';
    setTimeout(()=>{ overlay.textContent='1';
      setTimeout(()=>{ overlay.textContent='GO';
        setTimeout(()=>{ overlay.textContent=''; startCb(); }, 300);
      }, 700);
    }, 700);
  }, 700);
}

/* ========= „Çπ„Çø„Éº„Éà/ÁµÇ‰∫Ü ========= */
function startGame(){
  restartBtn.style.display='none';
  fullReset(); resize(); resetLevel(); render();
  countdownThen(()=>{
    running=true;               // ‚Üê „Åì„Åì„ÅßÁ¢∫ÂÆü„Å´ÈñãÂßã
    lastTs=performance.now();
    angleHint.style.display='block';
    gaugeWrap.style.display='none';
    startBtn.disabled=true;
  });
}
startBtn.addEventListener('click', startGame);
restartBtn.addEventListener('click', startGame);

function finishGame(){
  finished=true; running=false;
  const finalCPU=cpuNames.map(n=>({name:n,score:Math.max(0,Math.round(cpuScores[n]))}));
  const me={name:'YOU',score:score};
  const all=[me,...finalCPU].sort((a,b)=>b.score-a.score);
  const pos=all.findIndex(p=>p.name==='YOU')+1;
  overlay.innerHTML=`ÁµÇ‰∫ÜÔºÅ<br>„ÅÇ„Å™„Åü„ÅØ ${pos} ‰ΩçÔºàÂÖ®8‰∫∫Ôºâ<br>SCORE ${score}`;
  restartBtn.style.display='block';
}
</script>
</body>
</html>
