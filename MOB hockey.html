<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>Balloon Smash 30 ‚Äì ËßíÂ∫¶„É©„Ç§„É≥Ôºã„Ç≤„Éº„Ç∏ / Ë∂Ö„Çπ„É≠„ÉºÈ¢®Ëàπ</title>
<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden}
  canvas{position:fixed;inset:0;display:block;width:100%;height:100%;touch-action:none}

  /* HUD */
  #hud{
    position:fixed; top:0; left:0; right:0; z-index:20;
    display:flex; gap:8px; justify-content:space-between; align-items:center;
    padding:8px 12px; color:#fff; font-family:system-ui,-apple-system,"Hiragino Sans","Yu Gothic",sans-serif;
    background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.15));
    -webkit-user-select:none; user-select:none;
  }
  .pill{background:#0f172a; border:1px solid #263040; border-radius:999px; padding:6px 10px; font-weight:800; min-width:92px; text-align:center}
  #start, #restart{
    appearance:none; border:1px solid #264861; border-radius:12px; padding:10px 14px;
    background:#0b2b3d; color:#dff3ff; font-weight:900;
  }
  #restart{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; z-index:20; display:none; }

  /* „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥„ÇÑÁµÇ‰∫ÜË°®Á§∫ */
  #overlay{
    position:fixed; inset:0; z-index:15; display:flex; align-items:center; justify-content:center;
    font-size:14vw; font-weight:900; color:#fff; text-shadow:0 0 18px rgba(0,0,0,.75);
    pointer-events:none;
  }
  @media (min-width:540px){ #overlay{font-size:72px} }

  /* ÁîªÈù¢‰∏ã„ÅÆ„Ç≤„Éº„Ç∏UI */
  #gaugeWrap{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:10px; width:min(86vw, 520px); height:16px; border-radius:10px; overflow:hidden;
    background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15); z-index:12; display:none;
  }
  #gaugeFill{height:100%; width:0%; background:linear-gradient(90deg,#1ad1ff,#5cfcc3);}

  /* ËßíÂ∫¶„É©„Ç§„É≥„ÅÆ„Éí„É≥„ÉàÔºà‰∏ãÈÉ®‰∏≠Â§ÆÔºâ */
  #angleHint{
    position:fixed; left:50%; transform:translateX(-50%); bottom:34px;
    color:#cbd5e1; font-size:12px; font-weight:700; font-family:system-ui,-apple-system,"Hiragino Sans","Yu Gothic",sans-serif;
    text-shadow:0 2px 6px rgba(0,0,0,.5); z-index:12; display:none;
  }
</style>
</head>
<body>
  <div id="hud">
    <div class="pill" id="timePill">TIME 30.0</div>
    <div class="pill" id="scorePill">SCORE 0</div>
    <button id="start">‚ñ∂ START</button>
  </div>

  <canvas id="cv"></canvas>
  <div id="overlay"></div>
  <button id="restart">üîÅ „É™„Çπ„Çø„Éº„Éà</button>

  <div id="angleHint">ÁîªÈù¢„Çí„Çø„ÉÉ„Éó„Åó„Å¶ËßíÂ∫¶„ÇíÊ±∫„ÇÅ„ÄÅÊäº„ÅóÁ∂ö„Åë„Å¶„Ç≤„Éº„Ç∏„ÇíÊ∫ú„ÇÅ„ÄÅÈõ¢„Åó„Å¶„Ç∑„Éß„ÉÉ„ÉàÔºÅ</div>
  <div id="gaugeWrap"><div id="gaugeFill"></div></div>

<script>
/* ========= Âü∫Êú¨„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó ========= */
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d', { alpha:false }); // ‰∏çÈÄèÊòé„Ç≠„É£„É≥„Éê„Çπ„ÅßÊÆãÂÉèÈò≤Ê≠¢
const overlay = document.getElementById('overlay');
const timeP = document.getElementById('timePill');
const scoreP = document.getElementById('scorePill');
const startBtn = document.getElementById('start');
const restartBtn = document.getElementById('restart');
const gaugeWrap = document.getElementById('gaugeWrap');
const gaugeFill = document.getElementById('gaugeFill');
const angleHint = document.getElementById('angleHint');

const DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
let W=0, H=0;
function resize(){
  W = cv.clientWidth;
  H = cv.clientHeight;
  cv.width  = Math.floor(W * DPR);
  cv.height = Math.floor(H * DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
addEventListener('resize', resize, {passive:true});
resize();

/* ========= ÁîªÂÉèÔºàÁÑ°„Åè„Å¶„ÇÇ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÊèèÁîªÔºâ ========= */
function loadImage(src){
  return new Promise(res=>{
    const img = new Image();
    img.onload = ()=>res(img);
    img.onerror = ()=>res(null);
    img.src = src;
  });
}
const assets = { bg:null, ball:null, balloon:null };
(async ()=>{
  assets.bg      = await loadImage('MOBhai.png');  // ËÉåÊôØ
  assets.ball    = await loadImage('red.png');     // ÁêÉ
  assets.balloon = await loadImage('Redb.png');    // È¢®Ëàπ
})();

/* ========= Áâ©ÁêÜ„Éª„É´„Éº„É´ ========= */
const GAME_TIME = 30.0;
const BALLOON_COUNT = 30;

// Â£ÅÔºö‰∏ä„Å†„ÅëÈñãÊîæÔºè Â∑¶Âè≥„Éª‰∏ã„ÅØÂèçÂ∞Ñ
const WALL = {L:10, R:()=>W-10, B:()=>H-10};

// „Ç∑„É•„Éº„Çø„ÉºÔºàÂéüÁÇπÔºâ„ÅØÁîªÈù¢‰∏ã‰∏≠Â§ÆÂõ∫ÂÆö
function SHOOT_ORIGIN(){ return {x: W*0.5, y: H*0.88}; }

const BALL_R  = 16;
const FRICTION = 0.994;        // ÁêÉ„ÅÆÊ∏õË°∞
const STOP_SPEED = 25;         // „Åì„ÇåÊú™Ê∫Ä„ÅßÂÅúÊ≠¢Êâ±„ÅÑÔºà„É™„Çª„ÉÉ„ÉàÔºâ
const POP_SPEED  = 220;        // È¢®Ëàπ„ÅåÂâ≤„Çå„ÇãÊúÄ‰ΩéÈÄüÂ∫¶Ôºàpx/sÔºâ

// „Ç∑„Éß„ÉÉ„ÉàÂº∑„ÅïÔºàÈï∑Êäº„Åó„Åß0‚ÜíMAXÔºâ
const POWER_MIN = 420;
const POWER_MAX = 1200;
const CHARGE_TIME = 1200;      // 0‚ÜíMAX Á¥Ñ1.2Áßí

/* ========= Áä∂ÊÖã ========= */
let running=false, finished=false, lastTs=0, timeLeft=GAME_TIME, score=0;
let balloons=[], needResetAfterExit=false;
let ball = { x:0, y:0, vx:0, vy:0, r:BALL_R };

// ÁÖßÊ∫ñÔºàËßíÂ∫¶„É©„Ç§„É≥Ôºã„Ç≤„Éº„Ç∏Ôºâ
let aiming = false;
let aimAngle = -Math.PI/2; // Áúü‰∏ä
let chargeStart = 0;

// È¢®Ëàπ„ÅÆÁµåÈÅéÊôÇÈñìÔºà„ÄåÊâì„Å§Ââç„Å®Êâì„Å£„ÅüÂæå„ÅßÂêå„ÅòÈÄüÂ∫¶„Äç„Çí‰øùË®ºÔºâ
let balloonElapsed = 0;

/* ========= CPUÔºà7‰∫∫Ôºâ ========= */
const cpuNames = ['CPU-1','CPU-2','CPU-3','CPU-4','CPU-5','CPU-6','CPU-7'];
let cpuScores = {}, cpuSkill = {};
function initCPU(){
  cpuScores = {}; cpuSkill = {};
  cpuNames.forEach(n=>{
    const base = 0.6 + Math.random()*0.7;   // 0.6„Äú1.3/Áßí
    const clutch = 0.15 + Math.random()*0.35;
    cpuSkill[n] = {base, clutch};
    cpuScores[n] = 0;
  });
}
function updateCPU(dt){
  const progress = 1 - (timeLeft/GAME_TIME);
  for(const n of cpuNames){
    const rate = cpuSkill[n].base + cpuSkill[n].clutch*progress;
    const expected = dt * rate;
    const burst = Math.random() < expected*0.35 ? 1 : 0;
    cpuScores[n] += (expected + burst);
  }
}

/* ========= ÂàùÊúüÂåñ ========= */
function resetLevel(){
  // Ë∂Ö„Çπ„É≠„ÉºÔºÜ‰∏ÄÂÆöÊåôÂãï„ÄÇX/Y„Å®„ÇÇ„ÄåÁõÆÊ®ô‰ΩçÁΩÆÊñπÂºè„ÄçÔºã„Äå1„Éï„É¨„Éº„É†„ÅÆÊúÄÂ§ßÂ§â‰Ωç„ÇØ„É©„É≥„Éó„Äç
  balloons = [];
  for(let i=0;i<BALLOON_COUNT;i++){
    const r = 16 + Math.random()*6;
    const x0 = WALL.L + r + Math.random()*(WALL.R()-WALL.L - r*2);
    const y0 = 20 + r + Math.random()*((H*0.60) - r*2); // ‰∏äÂÅ¥„Å´ÈÖçÁΩÆ
    balloons.push({
      // ‚ÄúÂü∫Ê∫ñ‚Äù
      baseX:x0, baseY:y0,
      // Ë°®Á§∫Â∫ßÊ®ôÔºàÂâçÂõûÊèèÁîª‰ΩçÁΩÆÔºâ
      x:x0, y:y0, r, alive:true,
      phase: Math.random()*Math.PI*2,
      amp: 0.3,       // Ê®™Êè∫„ÇåÊúÄÂ§ß ¬±0.3pxÔºà„Åª„Çì„ÅÆÂ∞ë„ÅóÔºâ
      drift: 0.4,     // ‰∏äÊòá 0.4px/sÔºà„Åã„Å™„ÇäÈÅÖ„ÅÑÔºâ
    });
  }

  // ÁêÉÔºö„Ç∑„É•„Éº„Çø„ÉºÂéüÁÇπ„Åã„ÇâÂ∞ë„Åó‰∏ä
  const o = SHOOT_ORIGIN();
  ball.x = o.x; ball.y = o.y - 40; ball.vx = 0; ball.vy = 0;

  needResetAfterExit = false;
  balloonElapsed = 0; // „Éï„Çß„Éº„Ç∫„ÅÆ‚ÄúÁµåÈÅéÊôÇÈñì‚Äù„ÇÇ„É™„Çª„ÉÉ„ÉàÔºàÂ∏∏„Å´Âêå„ÅòÈÄüÂ∫¶Ôºâ
}

function fullReset(){
  score = 0; timeLeft = GAME_TIME; finished=false; running=false; lastTs=0;
  initCPU();
  resetLevel();
  updateHUD();
}
fullReset();

function updateHUD(){
  timeP.textContent = `TIME ${timeLeft.toFixed(1)}`;
  scoreP.textContent = `SCORE ${score}`;
}

/* ========= ÂÖ•ÂäõÔºöËßíÂ∫¶„É©„Ç§„É≥Ôºã„Ç≤„Éº„Ç∏ ========= */
function canvasPoint(e){
  const rect = cv.getBoundingClientRect();
  return { x: e.clientX - rect.left, y: e.clientY - rect.top };
}
cv.addEventListener('pointerdown', (e)=>{
  if(!running || finished) return;
  aiming = true;
  angleHint.style.display = 'block';
  gaugeWrap.style.display = 'block';
  const p = canvasPoint(e);
  const o = SHOOT_ORIGIN();
  aimAngle = Math.atan2(p.y - o.y, p.x - o.x);
  // ‰∏ãÂêë„Åç„ÅØÁ¶ÅÊ≠¢Ôºà-170¬∞„Äú-10¬∞„ÅÆ„ÅøË®±ÂèØÔºâ
  aimAngle = Math.max(-Math.PI*0.95, Math.min(-Math.PI*0.05, aimAngle));
  chargeStart = performance.now();
  gaugeFill.style.width = '0%';
});
cv.addEventListener('pointermove', (e)=>{
  if(!aiming) return;
  const p = canvasPoint(e);
  const o = SHOOT_ORIGIN();
  let ang = Math.atan2(p.y - o.y, p.x - o.x);
  const minAng = -Math.PI * 0.95, maxAng = -Math.PI * 0.05;
  if(ang < minAng) ang = minAng; if(ang > maxAng) ang = maxAng;
  aimAngle = ang;
});
addEventListener('pointerup', ()=>{
  if(!aiming) return;
  aiming = false;
  angleHint.style.display = 'none';
  gaugeWrap.style.display = 'none';
  const t = performance.now() - chargeStart;
  const rate = Math.max(0, Math.min(1, t / CHARGE_TIME));
  const power = POWER_MIN + (POWER_MAX - POWER_MIN) * rate;
  ball.vx = Math.cos(aimAngle) * power;
  ball.vy = Math.sin(aimAngle) * power;
});

/* ========= Áâ©ÁêÜ ========= */
function reflectWalls(){
  if(ball.x - ball.r < WALL.L){ ball.x = WALL.L + ball.r; ball.vx *= -1; }
  if(ball.x + ball.r > WALL.R()){ ball.x = WALL.R() - ball.r; ball.vx *= -1; }
  if(ball.y + ball.r > WALL.B()){ ball.y = WALL.B() - ball.r; ball.vy *= -1; }
  if(ball.y + ball.r < 0){ needResetAfterExit = true; }
}

// È¢®ËàπÔºöÁõÆÊ®ô‰ΩçÁΩÆÊñπÂºèÔºãÊúÄÂ§ßÂ§â‰Ωç„ÇØ„É©„É≥„ÉóÔºàdt„ÅÆË∑≥„Å≠„Å´„Çà„ÇãÊö¥„Çå„ÇíÊäëÊ≠¢Ôºâ
function updateBalloons(dt){
  balloonElapsed += dt;

  // ÁõÆÊ®ôÂÄ§„ÅÆÊõ¥Êñ∞„Å´ dt „Çí‰ΩøÁî®Ôºà‚ÄúÂêå„ÅòÈÄüÂ∫¶‚Äù„Çí‰øùË®ºÔºâ
  for(const b of balloons){
    if(!b.alive) continue;

    // ËßíÈÄüÂ∫¶ÔºàË∂Ö‰ΩéÈÄüÔºâÔºö0.04rad/s
    b.phase += dt * 0.04;

    // ÁõÆÊ®ô‰ΩçÁΩÆ
    const targetX = b.baseX + Math.sin(b.phase) * b.amp;               // ¬±0.3px
    const targetY = b.baseY - b.drift * balloonElapsed;                 // 0.4px/s ‰∏äÊòá

    // 1„Éï„É¨„Éº„É†ÊúÄÂ§ßÁßªÂãïÈáè„ÇíÂé≥Ê†º„Å´Âà∂ÈôêÔºàpx/frameÔºâ
    const maxStep = 0.30; // ‚Üê „Åì„Åì„Åå„ÄåÊÆãÂÉèÊ∂à„Åó„Äç„ÅÆÊ±∫„ÇÅÊâã
    const dx = Math.max(-maxStep, Math.min(maxStep, targetX - b.x));
    const dy = Math.max(-maxStep, Math.min(maxStep, targetY - b.y));
    b.x += dx;
    b.y += dy;

    // ÁîªÈù¢ÂÜÖ„ÇØ„É©„É≥„ÉóÔºàË∑≥„Å≠Ëøî„Çâ„Å™„ÅÑÔºö„Ç¨„Çø„Å§„ÅçÈò≤Ê≠¢Ôºâ
    const minX = WALL.L + b.r, maxX = WALL.R() - b.r;
    const minY = 12 + b.r;
    if(b.x < minX) b.x = minX;
    if(b.x > maxX) b.x = maxX;
    if(b.y < minY) b.y = minY;
  }
}

function hitBalloons(){
  const sp2 = ball.vx*ball.vx + ball.vy*ball.vy;
  const need = POP_SPEED * POP_SPEED;
  for(const b of balloons){
    if(!b.alive) continue;
    const d = Math.hypot(ball.x - b.x, ball.y - b.y);
    if(d < ball.r + b.r){
      if(sp2 >= need){
        b.alive = false;
        score += 1;
      }
      // ÁêÉ„ÅØÊ∏õÈÄü„Åõ„ÅöË≤´ÈÄö
    }
  }
}

/* ========= „É´„Éº„Éó ========= */
function step(ts){
  if(!lastTs) lastTs = ts;
  const dt = Math.min(0.05, (ts - lastTs)/1000); // „Éï„É™„Éº„Ç∫Âæå„ÅÆÊö¥Ëµ∞ÊäëÊ≠¢
  lastTs = ts;

  if(running && !finished){
    timeLeft = Math.max(0, timeLeft - dt);
    updateCPU(dt);

    // ÁêÉ
    ball.x += ball.vx * dt;
    ball.y += ball.vy * dt;

    reflectWalls();
    updateBalloons(dt);
    hitBalloons();

    // Êë©Êì¶
    ball.vx *= FRICTION;
    ball.vy *= FRICTION;

    const speed = Math.hypot(ball.vx, ball.vy);
    if(speed < STOP_SPEED || needResetAfterExit){
      resetLevel();
    }

    if(timeLeft <= 0){
      finishGame();
    }

    updateHUD();
  }

  render();
  requestAnimationFrame(step);
}
requestAnimationFrame(step);

/* ========= ÊèèÁîª ========= */
function drawBackground(){
  if(assets.bg){
    // cover
    const iw = assets.bg.width, ih = assets.bg.height;
    const rImg = iw/ih, rCv = W/H;
    let dw, dh;
    if(rImg > rCv){ dh = H; dw = dh * rImg; } else { dw = W; dh = dw / rImg; }
    const dx = (W - dw)/2, dy = (H - dh)/2;
    ctx.drawImage(assets.bg, dx, dy, dw, dh);
  }else{
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,'#0e1322'); g.addColorStop(1,'#070b13');
    ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
  }
}
function drawWalls(){
  // Â∑¶„ÉªÂè≥„Éª‰∏ãÔºà‰∏ä„ÅØÈñãÊîæÔºâ
  ctx.fillStyle = 'rgba(12,25,45,0.90)';
  ctx.fillRect(0,0, WALL.L, H);
  ctx.fillRect(WALL.R(),0, W - WALL.R(), H);
  ctx.fillRect(0, WALL.B(), W, H - WALL.B());
  ctx.fillStyle = 'rgba(42,58,98,0.55)';
  ctx.fillRect(WALL.L-3,0,3,H);
  ctx.fillRect(WALL.R(),0,3,H);
  ctx.fillRect(0,WALL.B(),W,3);
}
function drawBalloon(b){
  if(!b.alive) return;
  if(assets.balloon){
    const d = b.r*2;
    ctx.drawImage(assets.balloon, b.x-b.r, b.y-b.r, d, d);
  }else{
    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºàËµ§„ÅÑÈ¢®ËàπÔºâ
    const g = ctx.createRadialGradient(b.x-4,b.y-6,4,b.x,b.y,b.r);
    g.addColorStop(0,'#ffb3b3'); g.addColorStop(1,'#c1121f');
    ctx.fillStyle = g;
    ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,255,255,.35)';
    ctx.beginPath(); ctx.ellipse(b.x-6,b.y-8, b.r*0.35, b.r*0.22, -0.6, 0, Math.PI*2); ctx.fill();
  }
}
function drawBall(){
  const {x,y,r} = ball;
  if(assets.ball){
    ctx.drawImage(assets.ball, x-r, y-r, r*2, r*2);
  }else{
    ctx.fillStyle = '#ef4444';
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  }
}
function drawAimLine(){
  if(!aiming) return;
  const o = SHOOT_ORIGIN();
  const t = performance.now() - chargeStart;
  const rate = Math.max(0, Math.min(1, t / CHARGE_TIME));
  const len = 160 + 60*rate; // Ë¶ñË™ç„Åó„ÇÑ„Åô„ÅÑÈï∑„Åï
  const ex = o.x + Math.cos(aimAngle)*len;
  const ey = o.y + Math.sin(aimAngle)*len;

  ctx.save();
  ctx.lineWidth = 3;
  ctx.strokeStyle = 'rgba(19,196,255,0.9)';
  ctx.fillStyle = 'rgba(19,196,255,0.25)';
  // Á∑ö
  ctx.beginPath(); ctx.moveTo(o.x,o.y); ctx.lineTo(ex,ey); ctx.stroke();
  // Áü¢Âç∞
  const ang = aimAngle;
  ctx.beginPath();
  ctx.moveTo(ex,ey);
  ctx.lineTo(ex - 12*Math.cos(ang-0.3), ey - 12*Math.sin(ang-0.3));
  ctx.lineTo(ex - 12*Math.cos(ang+0.3), ey - 12*Math.sin(ang+0.3));
  ctx.closePath(); ctx.fill();
  ctx.restore();

  // „Ç≤„Éº„Ç∏UI
  gaugeFill.style.width = `${rate*100}%`;
}
function render(){
  ctx.clearRect(0,0,W,H); // ÂÆåÂÖ®„ÇØ„É™„Ç¢ÔºàÊÆãÂÉèÂØæÁ≠ñÔºâ

  drawBackground();
  drawWalls();

  for(const b of balloons) drawBalloon(b);
  drawBall();
  drawAimLine();

  // „Ç∑„É•„Éº„Çø„ÉºÂéüÁÇπ
  const o = SHOOT_ORIGIN();
  ctx.fillStyle = 'rgba(255,255,255,.18)';
  ctx.beginPath(); ctx.arc(o.x, o.y, 10, 0, Math.PI*2); ctx.fill();
}

/* ========= „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ ‚Üí „Çπ„Çø„Éº„Éà ========= */
function startCountdownThenRun(){
  let n = 3;
  overlay.textContent = n;
  const t = setInterval(()=>{
    n--;
    if(n>0){ overlay.textContent = n; }
    else if(n===0){ overlay.textContent = 'GO'; }
    else{
      clearInterval(t);
      overlay.textContent = '';
      running = true;
      lastTs = performance.now();
      angleHint.style.display = 'block';
      gaugeWrap.style.display = 'none';
    }
  }, 700);
}
function startGame(){
  startBtn.disabled = true;
  restartBtn.style.display = 'none';
  fullReset();
  resize();
  resetLevel();
  render(); // ‰∫ãÂâç„Å´‰∏ÄÂ∫¶ÊèèÁîª
  startCountdownThenRun();
}
startBtn.addEventListener('click', startGame);
restartBtn.addEventListener('click', startGame);

/* ========= ÁµÇ‰∫Ü ========= */
function finishGame(){
  finished = true;
  running  = false;
  const finalCPU = cpuNames.map(n=>({name:n, score:Math.max(0, Math.round(cpuScores[n]))}));
  const me = {name:'YOU', score:score};
  const all = [me, ...finalCPU].sort((a,b)=>b.score-a.score);
  const pos = all.findIndex(p=>p.name==='YOU')+1;
  overlay.innerHTML = `ÁµÇ‰∫ÜÔºÅ<br>„ÅÇ„Å™„Åü„ÅØ ${pos} ‰ΩçÔºàÂÖ®8‰∫∫Ôºâ<br>SCORE ${score}`;
  restartBtn.style.display = 'block';
}

/* ========= „É°„Ç§„É≥„É´„Éº„Éó ========= */
(function loop(ts){
  if(!lastTs) lastTs = ts;
  const dt = Math.min(0.05, (ts - lastTs)/1000);
  lastTs = ts;

  if(running && !finished){
    timeLeft = Math.max(0, timeLeft - dt);
    updateCPU(dt);

    ball.x += ball.vx * dt;
    ball.y += ball.vy * dt;

    reflectWalls();
    updateBalloons(dt);
    hitBalloons();

    ball.vx *= FRICTION;
    ball.vy *= FRICTION;

    const speed = Math.hypot(ball.vx, ball.vy);
    if(speed < STOP_SPEED || needResetAfterExit){
      resetLevel();
    }
    if(timeLeft <= 0){
      finishGame();
    }
    updateHUD();
  }

  render();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
