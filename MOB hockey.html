<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>Balloon Smash 30 â€“ ç¢ºå®Ÿèµ·å‹•ãƒ»ä½é€Ÿé¢¨èˆ¹ãƒ»ãƒ‘ãƒ‰ãƒ«ä¸‹éƒ¨é™å®š</title>
<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden}
  #hud{
    position:fixed; top:0; left:0; right:0; z-index:20;
    display:flex; gap:8px; justify-content:space-between; align-items:center;
    padding:8px 12px; color:#fff; font-family:system-ui,-apple-system,"Hiragino Sans","Yu Gothic",sans-serif;
    background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.15));
    -webkit-user-select:none; user-select:none;
  }
  #hud .pill{background:#0f172a; border:1px solid #263040; border-radius:999px; padding:6px 10px; font-weight:800; min-width:92px; text-align:center}
  #start, #restart{
    appearance:none; border:1px solid #264861; border-radius:12px; padding:10px 14px;
    background:#0b2b3d; color:#dff3ff; font-weight:900;
  }
  #restart{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; z-index:20; display:none; }

  #cv{ position:fixed; inset:0; width:100%; height:100%; display:block; touch-action:none; background:#000; }

  #overlay{
    position:fixed; inset:0; z-index:15; display:flex; align-items:center; justify-content:center;
    font-size:14vw; font-weight:900; color:#fff; text-shadow:0 0 18px rgba(0,0,0,.75);
    pointer-events:none; /* â† é‡è¦ï¼šã“ã‚Œã§Startãƒœã‚¿ãƒ³ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ */
  }
  @media (min-width:540px){
    #overlay{font-size:72px}
  }
</style>
</head>
<body>
  <div id="hud">
    <div class="pill" id="timePill">TIME 30.0</div>
    <div class="pill" id="scorePill">SCORE 0</div>
    <button id="start">â–¶ START</button>
  </div>

  <canvas id="cv"></canvas>
  <div id="overlay"></div>
  <button id="restart">ğŸ” ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>

<script>
/* ===================== åŸºæœ¬ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ===================== */
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
const overlay = document.getElementById('overlay');
const timeP = document.getElementById('timePill');
const scoreP = document.getElementById('scorePill');
const startBtn = document.getElementById('start');
const restartBtn = document.getElementById('restart');

const DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
let W=0, H=0;
function resize(){
  W = cv.clientWidth;
  H = cv.clientHeight;
  cv.width  = Math.floor(W * DPR);
  cv.height = Math.floor(H * DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
addEventListener('resize', resize, {passive:true});
resize();

/* ===================== ç”»åƒï¼ˆå­˜åœ¨ã—ãªãã¦ã‚‚OKãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æç”»ï¼‰ ===================== */
function loadImage(src){
  return new Promise(res=>{
    const img = new Image();
    img.onload = ()=>res(img);
    img.onerror = ()=>res(null);
    img.src = src;
  });
}
const assets = { bg:null, smasher:null, ball:null, balloon:null };
(async ()=>{
  assets.bg      = await loadImage('MOBhai.png');  // èƒŒæ™¯
  assets.smasher = await loadImage('smash.png');   // ãƒ‘ãƒ‰ãƒ«
  assets.ball    = await loadImage('red.png');     // çƒ
  assets.balloon = await loadImage('Redb.png');    // é¢¨èˆ¹
})();

/* ===================== ç‰©ç†ãƒ»ãƒ«ãƒ¼ãƒ« ===================== */
const GAME_TIME = 30.0;
const BALLOON_COUNT = 30;

// å£ï¼šä¸Šã ã‘é–‹æ”¾ï¼ˆæŠœã‘ãŸã‚‰ãƒªã‚»ãƒƒãƒˆï¼‰ï¼ å·¦å³ãƒ»ä¸‹ã¯åå°„
const WALL = {L:10, R:()=>W-10, B:()=>H-10};

// ã‚¹ãƒãƒƒã‚·ãƒ£ãƒ¼ï¼ˆãƒ‘ãƒ‰ãƒ«ï¼‰å¯å‹•åŸŸï¼šç”»é¢ä¸‹éƒ¨ã®ã¿ï¼ˆé¢¨èˆ¹ã«è§¦ã‚Œãªã„ï¼‰
const PADDLE_ZONE_TOP = ()=>H*0.72;
const PADDLE_ZONE_BTM = ()=>H*0.92;
const SMASH_R = 40;
const BALL_R  = 16;

const FRICTION = 0.994;        // çƒã®æ¸›è¡°
const STOP_SPEED = 25;         // ã“ã‚Œæœªæº€ã§åœæ­¢æ‰±ã„ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰
const POP_SPEED  = 220;        // é¢¨èˆ¹ãŒå‰²ã‚Œã‚‹æœ€ä½é€Ÿåº¦

/* ===================== çŠ¶æ…‹ ===================== */
let running=false, finished=false, lastTs=0, timeLeft=GAME_TIME, score=0;
let smasher, ball, balloons=[], needResetAfterExit=false;

/* ===================== åˆæœŸåŒ– ===================== */
function resetLevel(){
  // é¢¨èˆ¹ï¼šå¸¸ã«ã€Œã‚†ã£ãã‚Šã€ï¼†ã€Œä¸€å®šã€æŒ™å‹•ï¼ˆé–‹å§‹ç›´å¾Œã ã‘é€Ÿã„å•é¡Œã‚’æ’é™¤ï¼‰
  balloons = [];
  for(let i=0;i<BALLOON_COUNT;i++){
    const r = 16 + Math.random()*6;
    const x = WALL.L + r + Math.random()*(WALL.R()-WALL.L - r*2);
    const y = 20 + r + Math.random()*((H*0.60) - r*2); // ä¸ŠåŠåˆ†ä»˜è¿‘
    const phase = Math.random()*Math.PI*2;
    const swayAmp = 0.35 + Math.random()*0.25; // æ¨ªãµã‚‰ã¤ãã¯å°ã•ã‚å›ºå®š
    const driftY  = 8;                          // å¸¸ã«ã‚†ã£ãã‚Šä¸Šæ–¹å‘ï¼ˆpx/sï¼‰
    balloons.push({x,y,r,alive:true,phase,swayAmp,driftY});
  }

  // ãƒ‘ãƒ‰ãƒ«ï¼ˆã‚¹ãƒãƒƒã‚·ãƒ£ãƒ¼ï¼‰ï¼šä¸‹éƒ¨å¸¯ã®ã¿å¯å‹•
  smasher = {
    x: W*0.5, y: PADDLE_ZONE_BTM()-4, r:SMASH_R,
    dragging:false, touchId:null,
    vx:0, vy:0, lastX:W*0.5, lastY:PADDLE_ZONE_BTM()-4
  };

  // çƒï¼šãƒ‘ãƒ‰ãƒ«æ‰‹å‰ã‹ã‚‰
  ball = { x: W*0.5, y: smasher.y-50, vx:0, vy:0, r:BALL_R };

  needResetAfterExit = false;
}

function fullReset(){
  score = 0; timeLeft = GAME_TIME; finished=false; running=false; lastTs=0;
  resetLevel();
  updateHUD();
}
fullReset();

function updateHUD(){
  timeP.textContent = `TIME ${timeLeft.toFixed(1)}`;
  scoreP.textContent = `SCORE ${score}`;
}

/* ===================== å…¥åŠ›ï¼šç‰‡æ‰‹ãƒ‰ãƒ©ãƒƒã‚°ï¼ˆãƒ‘ãƒ‰ãƒ«å¸¯ã ã‘åå¿œï¼‰ ===================== */
function isInPaddleZone(x,y){
  return (y >= PADDLE_ZONE_TOP() && y <= PADDLE_ZONE_BTM());
}
function clampPaddle(x,y){
  const minX = WALL.L + SMASH_R;
  const maxX = WALL.R() - SMASH_R;
  const minY = PADDLE_ZONE_TOP() + SMASH_R*0.5;
  const maxY = PADDLE_ZONE_BTM() - SMASH_R*0.2;
  return {
    x: Math.max(minX, Math.min(maxX, x)),
    y: Math.max(minY, Math.min(maxY, y)),
  };
}
// Pointer Eventsï¼ˆiOS Safari ã§ã‚‚ä½¿ç”¨å¯ï¼‰
cv.addEventListener('pointerdown', (e)=>{
  const rect = cv.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  if(!running || finished) return;
  if(isInPaddleZone(x,y)){
    smasher.dragging = true;
    const c = clampPaddle(x,y);
    smasher.lastX = smasher.x; smasher.lastY = smasher.y;
    smasher.x = c.x; smasher.y = c.y;
  }
});
cv.addEventListener('pointermove', (e)=>{
  if(!smasher.dragging) return;
  const rect = cv.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  const c = clampPaddle(x,y);
  // é€Ÿåº¦ï¼ˆãƒ‘ãƒ‰ãƒ«ç§»å‹•ï¼‰ã‚’æ¯ãƒ•ãƒ¬ãƒ¼ãƒ æ¨å®šï¼šåå°„ã«å°‘ã—å¯„ä¸
  smasher.vx = (c.x - smasher.x) * 60;
  smasher.vy = (c.y - smasher.y) * 60;
  smasher.lastX = smasher.x; smasher.lastY = smasher.y;
  smasher.x = c.x; smasher.y = c.y;
});
addEventListener('pointerup', ()=>{ smasher.dragging=false; });

/* ===================== ç‰©ç† ===================== */
function reflectWalls(){
  if(ball.x - ball.r < WALL.L){ ball.x = WALL.L + ball.r; ball.vx *= -1; }
  if(ball.x + ball.r > WALL.R()){ ball.x = WALL.R() - ball.r; ball.vx *= -1; }
  if(ball.y + ball.r > WALL.B()){ ball.y = WALL.B() - ball.r; ball.vy *= -1; }
  if(ball.y + ball.r < 0){ needResetAfterExit = true; }
}
function collidePaddle(){
  // ã‚¨ã‚¢ãƒ›ãƒƒã‚±ãƒ¼é¢¨ï¼šå††ã¨å††ã®è¡çªã§æ³•ç·šåå°„ + ãƒ‘ãƒ‰ãƒ«ã®ç§»å‹•é€Ÿåº¦ã‚’å°‘ã—åŠ ãˆã‚‹
  const dx = ball.x - smasher.x;
  const dy = ball.y - smasher.y;
  const dist = Math.hypot(dx,dy);
  const minDist = ball.r + smasher.r*0.9;
  if(dist < minDist){
    const nx = dx / (dist || 1);
    const ny = dy / (dist || 1);
    // æŠ¼ã—æˆ»ã—ã¦é‡ãªã‚Šã‚’è§£æ¶ˆ
    const overlap = (minDist - dist);
    ball.x += nx * overlap;
    ball.y += ny * overlap;
    // åå°„
    const vDotN = ball.vx*nx + ball.vy*ny;
    ball.vx -= 2 * vDotN * nx;
    ball.vy -= 2 * vDotN * ny;
    // ãƒ‘ãƒ‰ãƒ«ç§»å‹•ã®å¯„ä¸
    ball.vx += smasher.vx * 0.35;
    ball.vy += smasher.vy * 0.35;
  }
}
function updateBalloons(dt){
  for(const b of balloons){
    if(!b.alive) continue;
    b.phase += dt * 0.5;                 // ã‚†ã£ãã‚Š
    b.x += Math.sin(b.phase)*b.swayAmp;   // æ¨ªãµã‚
    b.y -= b.driftY * dt * 0.5;          // ã”ãç·©ã‚„ã‹ã«ä¸Š
    // ç”»é¢å†…ã«è»½ãæˆ»ã™
    if(b.x < WALL.L + b.r) b.x = WALL.L + b.r;
    if(b.x > WALL.R() - b.r) b.x = WALL.R() - b.r;
    if(b.y < 12 + b.r) b.y = 12 + b.r;
  }
}
function hitBalloons(){
  const sp2 = ball.vx*ball.vx + ball.vy*ball.vy;
  const need = POP_SPEED * POP_SPEED;
  for(const b of balloons){
    if(!b.alive) continue;
    const d = Math.hypot(ball.x - b.x, ball.y - b.y);
    if(d < ball.r + b.r){
      if(sp2 >= need){
        b.alive = false;
        score += 1;
      }
      // çƒã¯æ¸›é€Ÿã›ãšè²«é€š
    }
  }
}

/* ===================== ãƒ«ãƒ¼ãƒ— ===================== */
function step(ts){
  if(!lastTs) lastTs = ts;
  const dt = Math.min(0.05, (ts - lastTs)/1000);
  lastTs = ts;

  if(running && !finished){
    timeLeft = Math.max(0, timeLeft - dt);

    // çƒã®æ›´æ–°
    ball.x += ball.vx * dt;
    ball.y += ball.vy * dt;

    reflectWalls();
    collidePaddle();
    updateBalloons(dt);
    hitBalloons();

    // æ‘©æ“¦
    ball.vx *= FRICTION;
    ball.vy *= FRICTION;

    const speed = Math.hypot(ball.vx, ball.vy);
    if(speed < STOP_SPEED || needResetAfterExit){
      resetLevel();
    }

    if(timeLeft <= 0){
      finishGame();
    }

    updateHUD();
  }

  render();
  requestAnimationFrame(step);
}
requestAnimationFrame(step);

/* ===================== æç”» ===================== */
function drawBackground(){
  if(assets.bg){
    // coverçš„ã«ãƒ•ã‚£ãƒƒãƒˆ
    const iw = assets.bg.width, ih = assets.bg.height;
    const rImg = iw/ih, rCv = W/H;
    let dw, dh;
    if(rImg > rCv){ // æ¨ªé•· â†’ é«˜ã•åŸºæº–
      dh = H; dw = dh * rImg;
    }else{          // ç¸¦é•· â†’ å¹…åŸºæº–
      dw = W; dh = dw / rImg;
    }
    const dx = (W - dw)/2, dy = (H - dh)/2;
    ctx.drawImage(assets.bg, dx, dy, dw, dh);
  }else{
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,'#0e1322'); g.addColorStop(1,'#070b13');
    ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
  }
}
function drawWalls(){
  // å·¦ãƒ»å³ãƒ»ä¸‹ã®å£ã€‚è‰²å¸¯ï¼‹è–„ã„å…‰
  ctx.fillStyle = 'rgba(12,25,45,0.85)';
  // å·¦
  ctx.fillRect(0,0, WALL.L, H);
  // å³
  ctx.fillRect(WALL.R(),0, W - WALL.R(), H);
  // ä¸‹
  ctx.fillRect(0, WALL.B(), W, H - WALL.B());

  ctx.fillStyle = 'rgba(42,58,98,0.5)';
  ctx.fillRect(WALL.L-3,0,3,H);
  ctx.fillRect(WALL.R(),0,3,H);
  ctx.fillRect(0,WALL.B(),W,3);
}
function drawBalloon(b){
  if(!b.alive) return;
  if(assets.balloon){
    const d = b.r*2;
    ctx.drawImage(assets.balloon, b.x-b.r, b.y-b.r, d, d);
  }else{
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆèµ¤ã„é¢¨èˆ¹ï¼‰
    const g = ctx.createRadialGradient(b.x-4,b.y-6,4,b.x,b.y,b.r);
    g.addColorStop(0,'#ffb3b3'); g.addColorStop(1,'#c1121f');
    ctx.fillStyle = g;
    ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,255,255,.35)';
    ctx.beginPath(); ctx.ellipse(b.x-6,b.y-8, b.r*0.35, b.r*0.22, -0.6, 0, Math.PI*2); ctx.fill();
  }
}
function drawSmasher(){
  const {x,y,r} = smasher;
  if(assets.smasher){
    ctx.drawImage(assets.smasher, x-r, y-r, r*2, r*2);
  }else{
    ctx.fillStyle = '#22d3ee';
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  }
}
function drawBall(){
  const {x,y,r} = ball;
  if(assets.ball){
    ctx.drawImage(assets.ball, x-r, y-r, r*2, r*2);
  }else{
    ctx.fillStyle = '#ef4444';
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  }
}
function render(){
  ctx.clearRect(0,0,W,H);
  drawBackground();
  drawWalls();
  // é¢¨èˆ¹
  for(const b of balloons) drawBalloon(b);
  // çƒã¨ã‚¹ãƒãƒƒã‚·ãƒ£ãƒ¼
  drawBall();
  drawSmasher();
}

/* ===================== ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ â†’ ã‚¹ã‚¿ãƒ¼ãƒˆ ===================== */
function startCountdownThenRun(){
  // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºã€‚overlayã¯ pointer-events:none ãªã®ã§Startã‚’é‚ªé­”ã—ãªã„
  let n = 3;
  overlay.textContent = n;
  const t = setInterval(()=>{
    n--;
    if(n>0){ overlay.textContent = n; }
    else if(n===0){ overlay.textContent = 'GO'; }
    else{
      clearInterval(t);
      overlay.textContent = '';
      running = true;
      lastTs = performance.now();
    }
  }, 700);
}

function startGame(){
  startBtn.disabled = true;
  restartBtn.style.display = 'none';
  fullReset();      // ã‚¹ã‚³ã‚¢ã¨æ™‚é–“ã‚’æˆ»ã—ã¦é…ç½®ã‚’ä½œã‚Šç›´ã™
  resize();         // å¿µã®ãŸã‚æœ€æ–°ã®ç”»é¢ã‚µã‚¤ã‚ºã§ã‚­ãƒ£ãƒ³ãƒã‚¹ç¢ºå®š
  resetLevel();     // é¢¨èˆ¹ã¨çƒã‚’å®‰å…¨ç¯„å›²ã«å†é…ç½®
  render();         // äº‹å‰ã«ä¸€åº¦æç”»ï¼ˆã€Œé¢¨èˆ¹ãŒæ˜ ã‚‰ãªã„ã€å¯¾ç­–ï¼‰
  startCountdownThenRun();
}
startBtn.addEventListener('click', startGame);
restartBtn.addEventListener('click', startGame);

/* ===================== ã‚²ãƒ¼ãƒ çµ‚äº† ===================== */
function finishGame(){
  finished = true;
  running  = false;
  overlay.textContent = `çµ‚äº†ï¼  SCORE ${score}`;
  restartBtn.style.display = 'block';
}
</script>
</body>
</html>
